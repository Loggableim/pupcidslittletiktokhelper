<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ClarityHUD - Chat Overlay</title>
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* CSS Custom Properties for Dynamic Configuration */
    :root {
      --chat-font-size: 48px;
      --chat-line-height: 1.6;
      --chat-letter-spacing: 0.5px;
      --chat-font-family: 'Exo 2', sans-serif;
      --chat-bg-color: rgba(0, 0, 0, 0.7);
      --chat-text-color: #ffffff;
      --chat-username-color: #00d4ff;
      --chat-text-outline: 1px 1px 2px rgba(0, 0, 0, 0.8);
      --chat-alignment: left;
      --chat-padding: 20px;
      --chat-message-spacing: 12px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--chat-font-family);
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      background: transparent;
    }

    #chat-container {
      width: 100%;
      height: 100%;
      padding: var(--chat-padding);
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      overflow: hidden;
    }

    #messages {
      display: flex;
      flex-direction: column;
      gap: var(--chat-message-spacing);
      overflow: hidden;
    }

    .chat-message {
      background: var(--chat-bg-color);
      padding: 16px 24px;
      border-radius: 8px;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 300ms ease-out, transform 300ms ease-out;
      word-wrap: break-word;
      overflow-wrap: break-word;
      hyphens: auto;
      text-align: var(--chat-alignment);
    }

    .chat-message.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .chat-username {
      color: var(--chat-username-color);
      font-weight: 700;
      font-size: var(--chat-font-size);
      line-height: var(--chat-line-height);
      letter-spacing: var(--chat-letter-spacing);
      text-shadow: var(--chat-text-outline);
      margin-right: 8px;
    }

    .chat-text {
      color: var(--chat-text-color);
      font-size: var(--chat-font-size);
      line-height: var(--chat-line-height);
      letter-spacing: var(--chat-letter-spacing);
      text-shadow: var(--chat-text-outline);
      display: inline;
    }

    .chat-timestamp {
      color: rgba(255, 255, 255, 0.6);
      font-size: calc(var(--chat-font-size) * 0.7);
      line-height: var(--chat-line-height);
      text-shadow: var(--chat-text-outline);
      margin-left: 12px;
      display: inline;
    }

    /* Accessibility: High Contrast Mode */
    body.high-contrast {
      --chat-bg-color: rgba(0, 0, 0, 1);
      --chat-text-color: #ffffff;
      --chat-username-color: #00ffff;
      --chat-text-outline: 2px 2px 4px rgba(0, 0, 0, 1);
    }

    /* Accessibility: Colorblind Safe Mode */
    body.colorblind-safe {
      --chat-username-color: #0066cc;
    }

    /* Accessibility: Vision Impaired Mode */
    body.vision-impaired .chat-message {
      padding: 20px 28px;
    }

    /* Accessibility: Reduce Motion */
    body.reduce-motion .chat-message {
      transition: opacity 100ms ease-out;
      transform: none !important;
    }

    /* Center alignment */
    body.align-center #messages {
      align-items: center;
    }

    body.align-center .chat-message {
      text-align: center;
    }

    /* Smooth scroll behavior */
    #messages {
      scroll-behavior: smooth;
    }
  </style>
</head>
<body>
  <div id="chat-container">
    <div id="messages"></div>
  </div>

  <!-- Socket.io -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- Libraries -->
  <script src="/plugins/clarityhud/lib/animations.js"></script>
  <script src="/plugins/clarityhud/lib/accessibility.js"></script>

  <script>
    // State management
    let settings = {
      fontSize: '48px',
      lineHeight: 1.6,
      letterSpacing: '0.5px',
      maxMessages: 10,
      showTimestamps: false,
      textAlign: 'left',
      animationType: 'slide',
      animationSpeed: 'medium',
      reduceMotion: false,
      dayNightMode: 'night',
      highContrastMode: false,
      colorblindSafeMode: false,
      visionImpairedMode: false,
      dyslexiaFont: false
    };

    let messages = [];
    let socket = null;
    let animationRegistry = null;
    let animationRenderer = null;
    let accessibilityManager = null;

    // DOM elements
    const messagesContainer = document.getElementById('messages');

    // Initialize animation system
    animationRegistry = new AnimationRegistry();
    animationRenderer = new AnimationRenderer(animationRegistry);

    // Initialize accessibility manager
    accessibilityManager = new AccessibilityManager();

    // Connect to socket
    socket = io();

    socket.on('connect', () => {
      console.log('Connected to server');
      init();
    });

    socket.on('disconnect', () => {
      console.log('Disconnected from server');
    });

    // Listen for chat updates
    socket.on('clarityhud.update.chat', (chatData) => {
      console.log('Received chat update:', chatData);
      addMessage(chatData);
    });

    // Listen for settings updates
    socket.on('clarityhud.settings.chat', (newSettings) => {
      console.log('Received settings update:', newSettings);
      applySettings(newSettings);
    });

    // Initialize overlay
    async function init() {
      try {
        // Load settings
        const settingsResponse = await fetch('/api/clarityhud/settings/chat');
        const settingsData = await settingsResponse.json();

        if (settingsData.success && settingsData.settings) {
          applySettings(settingsData.settings);
        }

        console.log('Chat overlay initialized');
      } catch (error) {
        console.error('Error initializing overlay:', error);
      }
    }

    // Apply settings
    function applySettings(newSettings) {
      settings = { ...settings, ...newSettings };

      // Apply CSS custom properties
      const root = document.documentElement;

      if (settings.fontSize) {
        root.style.setProperty('--chat-font-size', settings.fontSize);
      }

      if (settings.lineHeight) {
        root.style.setProperty('--chat-line-height', settings.lineHeight);
      }

      if (settings.letterSpacing) {
        root.style.setProperty('--chat-letter-spacing', settings.letterSpacing);
      }

      if (settings.textAlign) {
        root.style.setProperty('--chat-alignment', settings.textAlign);
        document.body.classList.toggle('align-center', settings.textAlign === 'center');
      }

      if (settings.backgroundColor) {
        root.style.setProperty('--chat-bg-color', settings.backgroundColor);
      }

      if (settings.textColor) {
        root.style.setProperty('--chat-text-color', settings.textColor);
      }

      if (settings.userNameColor) {
        root.style.setProperty('--chat-username-color', settings.userNameColor);
      }

      if (settings.textOutline) {
        root.style.setProperty('--chat-text-outline', settings.textOutline);
      }

      if (settings.padding) {
        root.style.setProperty('--chat-padding', settings.padding);
      }

      if (settings.messageSpacing) {
        root.style.setProperty('--chat-message-spacing', settings.messageSpacing);
      }

      // Apply accessibility settings
      accessibilityManager.applySettings(settings);

      // Update reduce motion in animation renderer
      if (animationRenderer) {
        animationRenderer.setReduceMotion(settings.reduceMotion || false);
      }

      // Update body classes
      document.body.classList.toggle('high-contrast', settings.highContrastMode);
      document.body.classList.toggle('colorblind-safe', settings.colorblindSafeMode);
      document.body.classList.toggle('vision-impaired', settings.visionImpairedMode);
      document.body.classList.toggle('reduce-motion', settings.reduceMotion);

      // Trim messages if max changed
      trimMessages();
    }

    // Add a message to the display
    function addMessage(chatData) {
      if (!chatData || !chatData.uniqueId || !chatData.comment) {
        console.warn('Invalid chat data:', chatData);
        return;
      }

      // Create message object
      const messageObj = {
        id: Date.now() + Math.random(),
        username: chatData.uniqueId,
        text: chatData.comment,
        timestamp: new Date()
      };

      // Add to messages array
      messages.push(messageObj);

      // Trim to max messages
      trimMessages();

      // Render message
      renderMessage(messageObj);
    }

    // Render a message element
    function renderMessage(messageObj) {
      // Create message element
      const messageEl = document.createElement('div');
      messageEl.className = 'chat-message';
      messageEl.dataset.id = messageObj.id;

      // Create username span
      const usernameEl = document.createElement('span');
      usernameEl.className = 'chat-username';
      usernameEl.textContent = messageObj.username + ':';

      // Create text span
      const textEl = document.createElement('span');
      textEl.className = 'chat-text';
      textEl.textContent = messageObj.text;

      // Append username and text
      messageEl.appendChild(usernameEl);
      messageEl.appendChild(textEl);

      // Add timestamp if enabled
      if (settings.showTimestamps) {
        const timestampEl = document.createElement('span');
        timestampEl.className = 'chat-timestamp';
        timestampEl.textContent = formatTimestamp(messageObj.timestamp);
        messageEl.appendChild(timestampEl);
      }

      // Add to container
      messagesContainer.appendChild(messageEl);

      // Animate in
      requestAnimationFrame(() => {
        animationRenderer.animateIn(
          messageEl,
          settings.animationType || 'slide',
          settings.animationSpeed || 'medium'
        ).then(() => {
          messageEl.classList.add('visible');
        });
      });
    }

    // Trim messages to max limit
    function trimMessages() {
      const maxMessages = settings.maxMessages || 10;

      // Remove excess messages from array
      while (messages.length > maxMessages) {
        const removedMessage = messages.shift();

        // Remove from DOM
        const messageEl = messagesContainer.querySelector(`[data-id="${removedMessage.id}"]`);
        if (messageEl) {
          // Animate out then remove
          animationRenderer.animateOut(
            messageEl,
            settings.animationType || 'slide',
            settings.animationSpeed || 'medium'
          ).then(() => {
            if (messageEl.parentNode) {
              messageEl.parentNode.removeChild(messageEl);
            }
          });
        }
      }

      // Also clean up any extra DOM elements (safety check)
      const messageElements = messagesContainer.querySelectorAll('.chat-message');
      if (messageElements.length > maxMessages) {
        for (let i = 0; i < messageElements.length - maxMessages; i++) {
          if (messageElements[i].parentNode) {
            messageElements[i].parentNode.removeChild(messageElements[i]);
          }
        }
      }
    }

    // Format timestamp
    function formatTimestamp(date) {
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      const seconds = date.getSeconds().toString().padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }

    // Detect system preference for reduced motion
    if (window.matchMedia) {
      const motionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
      if (motionQuery.matches && !settings.reduceMotion) {
        settings.reduceMotion = true;
        animationRenderer.setReduceMotion(true);
        document.body.classList.add('reduce-motion');
      }

      // Listen for changes
      motionQuery.addEventListener('change', (e) => {
        if (!settings.reduceMotion) {
          const shouldReduce = e.matches;
          animationRenderer.setReduceMotion(shouldReduce);
          document.body.classList.toggle('reduce-motion', shouldReduce);
        }
      });
    }
  </script>
</body>
</html>
