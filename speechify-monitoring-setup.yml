# Speechify TTS Integration - Monitoring & Alerting Setup
# Prometheus + Grafana Configuration

# =============================================================================
# PROMETHEUS METRICS
# =============================================================================

# File: /plugins/tts/engines/speechify-engine.js
# Add these metrics to track Speechify performance

prometheus_metrics:
  # Request counters
  - name: speechify_requests_total
    type: counter
    help: "Total number of Speechify TTS requests"
    labels: [status, voice, language]

  - name: speechify_requests_success_total
    type: counter
    help: "Successful Speechify requests"
    labels: [voice]

  - name: speechify_requests_failed_total
    type: counter
    help: "Failed Speechify requests"
    labels: [error_type, status_code]

  # Latency histograms
  - name: speechify_request_duration_seconds
    type: histogram
    help: "Speechify API request duration in seconds"
    buckets: [0.5, 1.0, 1.5, 2.0, 3.0, 5.0, 10.0]
    labels: [voice]

  - name: speechify_synthesis_duration_seconds
    type: histogram
    help: "Time to synthesize audio (server-side)"
    buckets: [0.3, 0.5, 0.8, 1.0, 1.5, 2.0]

  # Cost tracking
  - name: speechify_characters_total
    type: counter
    help: "Total characters processed by Speechify"
    labels: [voice, language]

  - name: speechify_cost_usd_total
    type: counter
    help: "Total estimated cost in USD"

  - name: speechify_daily_cost_usd
    type: gauge
    help: "Daily cost (resets at midnight UTC)"

  - name: speechify_hourly_cost_usd
    type: gauge
    help: "Hourly cost (rolling 1h window)"

  # Fallback tracking
  - name: speechify_fallbacks_total
    type: counter
    help: "Number of fallbacks to other engines"
    labels: [target_engine, reason]

  - name: speechify_fallback_rate
    type: gauge
    help: "Percentage of requests falling back"

  # API status
  - name: speechify_api_availability
    type: gauge
    help: "Speechify API availability (1 = up, 0 = down)"

  - name: speechify_rate_limits_total
    type: counter
    help: "Number of rate limit errors (429)"

  - name: speechify_api_errors_total
    type: counter
    help: "API errors by status code"
    labels: [status_code, error_message]

  # Queue metrics
  - name: speechify_queue_size
    type: gauge
    help: "Current Speechify queue size"

  - name: speechify_queue_wait_seconds
    type: histogram
    help: "Time items wait in queue"
    buckets: [1, 5, 10, 30, 60, 120]

# =============================================================================
# GRAFANA DASHBOARDS
# =============================================================================

grafana_dashboards:
  - name: "TTS Speechify - Overview"
    uid: "tts-speechify-overview"
    panels:
      # Row 1: Key Metrics
      - title: "Request Rate"
        type: graph
        query: "rate(speechify_requests_total[5m])"
        unit: "req/s"

      - title: "Success Rate"
        type: singlestat
        query: "(sum(rate(speechify_requests_success_total[5m])) / sum(rate(speechify_requests_total[5m]))) * 100"
        unit: "%"
        thresholds:
          - value: 95
            color: red
          - value: 98
            color: yellow
          - value: 99
            color: green

      - title: "P95 Latency"
        type: graph
        query: "histogram_quantile(0.95, rate(speechify_request_duration_seconds_bucket[5m]))"
        unit: "s"
        alert:
          condition: "> 3"
          severity: warning

      - title: "Current Queue Size"
        type: singlestat
        query: "speechify_queue_size"
        unit: "items"

      # Row 2: Cost Tracking
      - title: "Hourly Cost"
        type: graph
        query: "speechify_hourly_cost_usd"
        unit: "USD"
        alert:
          condition: "> 5"
          severity: warning

      - title: "Daily Cost"
        type: singlestat
        query: "speechify_daily_cost_usd"
        unit: "USD"
        thresholds:
          - value: 50
            color: red
          - value: 30
            color: yellow
          - value: 0
            color: green

      - title: "Characters Processed (1h)"
        type: graph
        query: "increase(speechify_characters_total[1h])"
        unit: "chars"

      - title: "Cost per 1k Characters"
        type: singlestat
        query: "(speechify_daily_cost_usd / (speechify_characters_total / 1000))"
        unit: "USD"

      # Row 3: Errors & Fallbacks
      - title: "Error Rate by Type"
        type: graph
        query: "sum(rate(speechify_requests_failed_total[5m])) by (error_type)"
        legend: "{{error_type}}"

      - title: "Fallback Rate"
        type: graph
        query: "(sum(rate(speechify_fallbacks_total[5m])) / sum(rate(speechify_requests_total[5m]))) * 100"
        unit: "%"
        alert:
          condition: "> 10"
          severity: warning

      - title: "Rate Limits (429)"
        type: singlestat
        query: "sum(increase(speechify_rate_limits_total[1h]))"
        unit: "errors"

      - title: "API Availability"
        type: singlestat
        query: "speechify_api_availability"
        thresholds:
          - value: 0
            color: red
          - value: 1
            color: green

      # Row 4: Voice Usage
      - title: "Top Voices (Requests)"
        type: graph
        query: "sum(rate(speechify_requests_total[1h])) by (voice)"
        legend: "{{voice}}"

      - title: "Voice Distribution"
        type: piechart
        query: "sum(increase(speechify_requests_total[24h])) by (voice)"

      - title: "Language Distribution"
        type: piechart
        query: "sum(increase(speechify_characters_total[24h])) by (language)"

# =============================================================================
# ALERT RULES
# =============================================================================

alert_rules:
  # Critical Alerts (PagerDuty)
  - name: SpeechifyAPIDown
    severity: critical
    expr: speechify_api_availability == 0
    for: 5m
    annotations:
      summary: "Speechify API is down"
      description: "Speechify API has been unavailable for 5 minutes"
    actions:
      - pagerduty: on-call
      - slack: "#incidents"

  - name: SpeechifyErrorRateCritical
    severity: critical
    expr: (sum(rate(speechify_requests_failed_total[5m])) / sum(rate(speechify_requests_total[5m]))) > 0.10
    for: 5m
    annotations:
      summary: "Speechify error rate > 10%"
      description: "Error rate: {{ $value | humanizePercentage }}"
    actions:
      - pagerduty: on-call
      - slack: "#incidents"

  - name: SpeechifyAPIKeyInvalid
    severity: critical
    expr: sum(increase(speechify_api_errors_total{status_code="401"}[5m])) > 0
    for: 1m
    annotations:
      summary: "Speechify API key invalid or expired"
      description: "Immediate action required: API key compromised"
    actions:
      - pagerduty: on-call
      - slack: "#incidents"
      - email: devops@example.com

  # High-Priority Alerts (Slack)
  - name: SpeechifyCostHigh
    severity: high
    expr: speechify_hourly_cost_usd > 5
    for: 10m
    annotations:
      summary: "Speechify hourly cost exceeds $5"
      description: "Current hourly cost: ${{ $value }}"
    actions:
      - slack: "#tts-alerts"
      - email: finance@example.com

  - name: SpeechifyDailyBudgetExceeded
    severity: high
    expr: speechify_daily_cost_usd > 50
    for: 1m
    annotations:
      summary: "Speechify daily budget exceeded ($50)"
      description: "Auto-disabling Speechify, falling back to TikTok"
    actions:
      - slack: "#tts-alerts"
      - webhook: "https://api.example.com/admin/disable-speechify"

  - name: SpeechifyLatencyHigh
    severity: high
    expr: histogram_quantile(0.95, rate(speechify_request_duration_seconds_bucket[5m])) > 5
    for: 10m
    annotations:
      summary: "Speechify P95 latency > 5s"
      description: "P95 latency: {{ $value }}s"
    actions:
      - slack: "#tts-alerts"

  # Medium-Priority Alerts
  - name: SpeechifyFallbackRateHigh
    severity: medium
    expr: (sum(rate(speechify_fallbacks_total[5m])) / sum(rate(speechify_requests_total[5m]))) > 0.20
    for: 15m
    annotations:
      summary: "Speechify fallback rate > 20%"
      description: "Fallback rate: {{ $value | humanizePercentage }}"
    actions:
      - slack: "#tts-monitoring"

  - name: SpeechifyRateLimitHigh
    severity: medium
    expr: sum(increase(speechify_rate_limits_total[5m])) > 10
    for: 5m
    annotations:
      summary: "High rate limiting from Speechify API"
      description: "{{ $value }} rate limit errors in 5 minutes"
    actions:
      - slack: "#tts-monitoring"

  # Low-Priority Alerts (Email Daily Digest)
  - name: SpeechifyDailyCostReport
    severity: low
    cron: "0 8 * * *"  # Daily at 8 AM UTC
    query: speechify_daily_cost_usd
    actions:
      - email: team@example.com
      - report: daily-cost-report

# =============================================================================
# SLACK NOTIFICATIONS
# =============================================================================

slack_notifications:
  channels:
    - name: "#incidents"
      severity: [critical]
      format: |
        üö® **CRITICAL ALERT: Speechify TTS**

        **Issue:** {{ .Summary }}
        **Details:** {{ .Description }}
        **Time:** {{ .Timestamp }}
        **Runbook:** https://wiki.example.com/runbook/speechify

        **Actions:**
        - Check Grafana: https://grafana.example.com/d/speechify
        - Review logs: https://logs.example.com/speechify
        - Execute rollback: `curl -X POST https://api.example.com/admin/rollback-speechify`

    - name: "#tts-alerts"
      severity: [high]
      format: |
        ‚ö†Ô∏è **WARNING: Speechify TTS**

        **Issue:** {{ .Summary }}
        **Value:** {{ .Value }}
        **Threshold:** {{ .Threshold }}

        **Dashboard:** https://grafana.example.com/d/speechify

    - name: "#tts-monitoring"
      severity: [medium, low]
      format: |
        ‚ÑπÔ∏è **INFO: Speechify TTS**

        **{{ .Summary }}**
        {{ .Description }}

# =============================================================================
# COST BUDGET AUTO-DISABLE
# =============================================================================

cost_budget:
  daily_limit: 50  # USD
  hourly_limit: 5  # USD

  auto_disable:
    enabled: true
    threshold: 50  # USD/day
    action: |
      # Webhook to disable Speechify
      curl -X POST https://api.example.com/admin/feature-flags \
        -H "Authorization: Bearer $ADMIN_TOKEN" \
        -d '{"speechify_enabled": false}'

      # Send notification
      curl -X POST $SLACK_WEBHOOK \
        -d '{"text": "‚ö†Ô∏è Speechify auto-disabled: Daily budget exceeded"}'

  notifications:
    - threshold: 40  # 80% of budget
      message: "Speechify cost at 80% of daily budget ($40/$50)"

    - threshold: 45  # 90% of budget
      message: "Speechify cost at 90% of daily budget ($45/$50)"

    - threshold: 50  # 100% of budget
      message: "Speechify DISABLED: Daily budget exceeded ($50)"

# =============================================================================
# PERFORMANCE BENCHMARKS
# =============================================================================

performance_benchmarks:
  latency:
    p50: 1.2  # seconds
    p95: 2.0
    p99: 3.0

  success_rate:
    target: 99.0  # percent
    warning: 98.0
    critical: 95.0

  throughput:
    target: 50  # req/s
    warning: 30

  cost:
    target_per_1k_chars: 0.015  # USD
    warning_hourly: 5.0  # USD
    critical_daily: 50.0  # USD

# =============================================================================
# LOGGING
# =============================================================================

logging:
  level: INFO

  categories:
    - name: speechify.requests
      level: DEBUG
      fields: [timestamp, voice, text_length, duration, status]

    - name: speechify.errors
      level: ERROR
      fields: [timestamp, error_type, status_code, message, stack_trace]

    - name: speechify.cost
      level: INFO
      fields: [timestamp, characters, cost_usd, cumulative_cost]

    - name: speechify.fallbacks
      level: WARN
      fields: [timestamp, reason, target_engine, original_error]

  retention:
    debug: 7d
    info: 30d
    warn: 90d
    error: 365d

# =============================================================================
# DASHBOARD LINKS
# =============================================================================

dashboards:
  grafana:
    main: "https://grafana.example.com/d/tts-speechify-overview"
    cost: "https://grafana.example.com/d/tts-speechify-cost"
    performance: "https://grafana.example.com/d/tts-speechify-performance"

  logs:
    kibana: "https://logs.example.com/app/discover#/speechify"

  metrics:
    prometheus: "https://prometheus.example.com/graph?g0.expr=speechify_requests_total"

# =============================================================================
# HEALTH CHECKS
# =============================================================================

health_checks:
  - name: speechify_api_health
    endpoint: "https://api.sws.speechify.com/health"
    interval: 60s
    timeout: 5s

  - name: speechify_test_synthesis
    description: "Test synthesis every 5 minutes"
    interval: 5m
    action: |
      curl -X POST https://api.example.com/api/tts/speak \
        -H "Content-Type: application/json" \
        -d '{
          "text": "Health check test",
          "username": "healthcheck",
          "engine": "speechify",
          "voiceId": "george"
        }'
    expected_status: 200
    timeout: 10s

# =============================================================================
# AUTOMATED RESPONSES
# =============================================================================

automated_responses:
  - trigger: SpeechifyAPIDown
    action: enable_fallback_to_google
    script: |
      # Auto-enable Google TTS as fallback
      curl -X POST https://api.example.com/admin/tts/config \
        -d '{"fallback_engine": "google"}'

  - trigger: SpeechifyDailyBudgetExceeded
    action: disable_speechify_switch_to_tiktok
    script: |
      # Disable Speechify, switch to TikTok
      curl -X POST https://api.example.com/admin/tts/config \
        -d '{"defaultEngine": "tiktok", "speechify_enabled": false}'

  - trigger: SpeechifyAPIKeyInvalid
    action: notify_devops_rotate_key
    script: |
      # Send urgent notification
      curl -X POST $PAGERDUTY_WEBHOOK \
        -d '{
          "severity": "critical",
          "summary": "Speechify API key invalid - rotation required"
        }'
