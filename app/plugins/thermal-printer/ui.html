<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thermal Printer - Configuration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #1a1a2e;
            color: #eaeaea;
        }
        .container {
            max-width: 900px;
            margin-top: 30px;
        }
        .card {
            background-color: #16213e;
            border: 1px solid #0f3460;
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #0f3460;
            border-bottom: 1px solid #533483;
        }
        .status-badge {
            font-size: 14px;
            padding: 8px 15px;
        }
        .btn-primary {
            background-color: #533483;
            border-color: #533483;
        }
        .btn-primary:hover {
            background-color: #6a4199;
            border-color: #6a4199;
        }
        .form-label {
            font-weight: 500;
        }
        .stats-box {
            background-color: #0f3460;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .stats-label {
            color: #999;
            font-size: 12px;
        }
        .stats-value {
            color: #eaeaea;
            font-size: 24px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-printer"></i> Thermal Printer Configuration</h1>
            <a href="/" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>

        <!-- Status Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-activity"></i> Status</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="stats-box">
                            <div class="stats-label">Connection Status</div>
                            <div class="stats-value" id="connection-status">
                                <span class="badge status-badge bg-secondary">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="stats-box">
                            <div class="stats-label">Queue Size</div>
                            <div class="stats-value" id="queue-size">0</div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="stats-box">
                            <div class="stats-label">Printed Jobs</div>
                            <div class="stats-value" id="printed-jobs">0</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-box">
                            <div class="stats-label">Failed Jobs</div>
                            <div class="stats-value" id="failed-jobs">0</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-box">
                            <div class="stats-label">Uptime</div>
                            <div class="stats-value" id="uptime">0s</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration Form -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-gear"></i> Configuration</h5>
            </div>
            <div class="card-body">
                <form id="config-form">
                    <!-- Enable/Disable -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enabled">
                            <label class="form-check-label" for="enabled">
                                <strong>Enable Thermal Printer</strong>
                            </label>
                        </div>
                    </div>

                    <hr>

                    <!-- Printer Connection -->
                    <h6 class="mb-3"><i class="bi bi-plug"></i> Printer Connection</h6>
                    
                    <div class="mb-3">
                        <label for="printerType" class="form-label">Printer Type</label>
                        <select class="form-select" id="printerType">
                            <option value="usb">USB</option>
                            <option value="network">Network</option>
                        </select>
                    </div>

                    <!-- USB Settings -->
                    <div id="usb-settings">
                        <div class="mb-3">
                            <label for="usbVendorId" class="form-label">USB Vendor ID</label>
                            <input type="text" class="form-control" id="usbVendorId" placeholder="0x04b8">
                            <small class="form-text text-muted">e.g., 0x04b8 for Epson (leave empty for auto-detect)</small>
                        </div>
                        <div class="mb-3">
                            <label for="usbProductId" class="form-label">USB Product ID</label>
                            <input type="text" class="form-control" id="usbProductId" placeholder="0x0e15">
                            <small class="form-text text-muted">e.g., 0x0e15 for TM-T20 (leave empty for auto-detect)</small>
                        </div>
                    </div>

                    <!-- Network Settings -->
                    <div id="network-settings" style="display: none;">
                        <div class="mb-3">
                            <label for="networkHost" class="form-label">Network Host/IP</label>
                            <input type="text" class="form-control" id="networkHost" placeholder="192.168.1.100">
                        </div>
                        <div class="mb-3">
                            <label for="networkPort" class="form-label">Network Port</label>
                            <input type="number" class="form-control" id="networkPort" placeholder="9100" min="1" max="65535">
                        </div>
                    </div>

                    <hr>

                    <!-- Event Filters -->
                    <h6 class="mb-3"><i class="bi bi-filter"></i> Event Filters</h6>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="printChats">
                            <label class="form-check-label" for="printChats">Print Chat Messages</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="printGifts">
                            <label class="form-check-label" for="printGifts">Print Gifts</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="printFollows">
                            <label class="form-check-label" for="printFollows">Print Follows</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="printShares">
                            <label class="form-check-label" for="printShares">Print Shares</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="minCoinsToPrint" class="form-label">Minimum Coins to Print (Gifts)</label>
                        <input type="number" class="form-control" id="minCoinsToPrint" min="0">
                        <small class="form-text text-muted">Only print gifts with at least this many coins (saves paper)</small>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="ignoreBotCommands">
                            <label class="form-check-label" for="ignoreBotCommands">
                                Ignore Bot Commands (messages starting with '!')
                            </label>
                        </div>
                    </div>

                    <hr>

                    <!-- Formatting -->
                    <h6 class="mb-3"><i class="bi bi-align-left"></i> Formatting</h6>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoCutPaper">
                            <label class="form-check-label" for="autoCutPaper">Auto-cut paper after each event</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="width" class="form-label">Paper Width (characters)</label>
                        <input type="number" class="form-control" id="width" min="32" max="80">
                        <small class="form-text text-muted">Typical: 48 for 80mm paper, 32 for 58mm paper</small>
                    </div>

                    <div class="mb-3">
                        <label for="encoding" class="form-label">Character Encoding</label>
                        <select class="form-select" id="encoding">
                            <option value="GB18030">GB18030 (Default)</option>
                            <option value="UTF-8">UTF-8</option>
                            <option value="ASCII">ASCII</option>
                        </select>
                    </div>

                    <hr>

                    <!-- Advanced Settings -->
                    <h6 class="mb-3"><i class="bi bi-sliders"></i> Advanced Settings</h6>
                    
                    <div class="mb-3">
                        <label for="reconnectAttempts" class="form-label">Reconnect Attempts</label>
                        <input type="number" class="form-control" id="reconnectAttempts" min="0">
                    </div>

                    <div class="mb-3">
                        <label for="reconnectDelay" class="form-label">Reconnect Delay (ms)</label>
                        <input type="number" class="form-control" id="reconnectDelay" min="0">
                    </div>

                    <div class="mb-3">
                        <label for="queueMaxSize" class="form-label">Max Queue Size</label>
                        <input type="number" class="form-control" id="queueMaxSize" min="1">
                    </div>

                    <div class="mb-3">
                        <label for="printDelay" class="form-label">Print Delay (ms)</label>
                        <input type="number" class="form-control" id="printDelay" min="0">
                        <small class="form-text text-muted">Delay between print jobs (prevents overloading)</small>
                    </div>

                    <!-- Buttons -->
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-success" id="test-print-btn">
                            <i class="bi bi-play-circle"></i> Test Print
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Save Configuration
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // Load Configuration
        async function loadConfig() {
            try {
                const response = await fetch('/api/thermal-printer/config');
                const data = await response.json();
                
                if (data.success) {
                    populateForm(data.config);
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        // Load Status
        async function loadStatus() {
            try {
                const response = await fetch('/api/thermal-printer/status');
                const data = await response.json();
                
                if (data.success) {
                    updateStatus(data.status);
                }
            } catch (error) {
                console.error('Error loading status:', error);
            }
        }

        // Populate Form
        function populateForm(config) {
            document.getElementById('enabled').checked = config.enabled;
            document.getElementById('printerType').value = config.printerType;
            document.getElementById('usbVendorId').value = config.usbVendorId || '';
            document.getElementById('usbProductId').value = config.usbProductId || '';
            document.getElementById('networkHost').value = config.networkHost;
            document.getElementById('networkPort').value = config.networkPort;
            document.getElementById('printChats').checked = config.printChats;
            document.getElementById('printGifts').checked = config.printGifts;
            document.getElementById('printFollows').checked = config.printFollows;
            document.getElementById('printShares').checked = config.printShares;
            document.getElementById('minCoinsToPrint').value = config.minCoinsToPrint;
            document.getElementById('ignoreBotCommands').checked = config.ignoreBotCommands;
            document.getElementById('autoCutPaper').checked = config.autoCutPaper;
            document.getElementById('width').value = config.width;
            document.getElementById('encoding').value = config.encoding;
            document.getElementById('reconnectAttempts').value = config.reconnectAttempts;
            document.getElementById('reconnectDelay').value = config.reconnectDelay;
            document.getElementById('queueMaxSize').value = config.queueMaxSize;
            document.getElementById('printDelay').value = config.printDelay;
            
            togglePrinterSettings();
        }

        // Update Status Display
        function updateStatus(status) {
            // Connection Status
            const statusEl = document.getElementById('connection-status');
            if (status.isConnected) {
                statusEl.innerHTML = '<span class="badge status-badge bg-success">Connected</span>';
            } else if (status.isReconnecting) {
                statusEl.innerHTML = '<span class="badge status-badge bg-warning">Reconnecting...</span>';
            } else {
                statusEl.innerHTML = '<span class="badge status-badge bg-danger">Disconnected</span>';
            }
            
            // Queue Size
            document.getElementById('queue-size').textContent = status.queueSize || 0;
            
            // Stats
            if (status.stats) {
                document.getElementById('printed-jobs').textContent = status.stats.printedJobs || 0;
                document.getElementById('failed-jobs').textContent = status.stats.failedJobs || 0;
                
                const uptime = status.stats.uptime || 0;
                const uptimeStr = formatUptime(uptime);
                document.getElementById('uptime').textContent = uptimeStr;
            }
        }

        // Format Uptime
        function formatUptime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes % 60}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }

        // Toggle Printer Settings
        function togglePrinterSettings() {
            const printerType = document.getElementById('printerType').value;
            const usbSettings = document.getElementById('usb-settings');
            const networkSettings = document.getElementById('network-settings');
            
            if (printerType === 'usb') {
                usbSettings.style.display = 'block';
                networkSettings.style.display = 'none';
            } else {
                usbSettings.style.display = 'none';
                networkSettings.style.display = 'block';
            }
        }

        // Save Configuration
        document.getElementById('config-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const config = {
                enabled: document.getElementById('enabled').checked,
                printerType: document.getElementById('printerType').value,
                usbVendorId: document.getElementById('usbVendorId').value,
                usbProductId: document.getElementById('usbProductId').value,
                networkHost: document.getElementById('networkHost').value,
                networkPort: parseInt(document.getElementById('networkPort').value),
                printChats: document.getElementById('printChats').checked,
                printGifts: document.getElementById('printGifts').checked,
                printFollows: document.getElementById('printFollows').checked,
                printShares: document.getElementById('printShares').checked,
                minCoinsToPrint: parseInt(document.getElementById('minCoinsToPrint').value),
                ignoreBotCommands: document.getElementById('ignoreBotCommands').checked,
                autoCutPaper: document.getElementById('autoCutPaper').checked,
                width: parseInt(document.getElementById('width').value),
                encoding: document.getElementById('encoding').value,
                reconnectAttempts: parseInt(document.getElementById('reconnectAttempts').value),
                reconnectDelay: parseInt(document.getElementById('reconnectDelay').value),
                queueMaxSize: parseInt(document.getElementById('queueMaxSize').value),
                printDelay: parseInt(document.getElementById('printDelay').value)
            };
            
            try {
                const response = await fetch('/api/thermal-printer/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Configuration saved successfully!');
                    loadStatus();
                } else {
                    alert('Error saving configuration: ' + (data.errors ? data.errors.join(', ') : data.error));
                }
            } catch (error) {
                console.error('Error saving config:', error);
                alert('Error saving configuration!');
            }
        });

        // Test Print
        document.getElementById('test-print-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/thermal-printer/test', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Test print job queued!');
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error test printing:', error);
                alert('Error sending test print!');
            }
        });

        // Printer Type Change
        document.getElementById('printerType').addEventListener('change', togglePrinterSettings);

        // Socket.IO Status Updates
        socket.on('thermal-printer:status', (data) => {
            if (data.status) {
                updateStatus(data.status);
            }
        });

        // Initial Load
        loadConfig();
        loadStatus();
        
        // Auto-refresh status every 5 seconds
        setInterval(loadStatus, 5000);
    </script>
</body>
</html>
