<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1920, height=1080">
    <title>TikTok Stream Overlay</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 1920px;
            height: 1080px;
            background: transparent;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        /* ========== AUDIO UNLOCK BUTTON ========== */
        #audio-unlock {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #audio-unlock:hover {
            transform: translate(-50%, -50%) scale(1.05);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }

        #audio-unlock.hidden {
            display: none;
        }

        /* ========== ALERT CONTAINER ========== */
        #alert-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            display: none;
        }

        #alert-container.show {
            display: block;
            animation: alertIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        #alert-container.hide {
            animation: alertOut 0.4s ease-in;
        }

        @keyframes alertIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes alertOut {
            from {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            to {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }

        #alert-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 60px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            text-align: center;
            min-width: 500px;
            border: 4px solid rgba(255, 255, 255, 0.3);
        }

        #alert-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin-bottom: 20px;
            border: 4px solid white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: none;
        }

        #alert-image.show {
            display: block;
            margin: 0 auto 20px;
        }

        #alert-text {
            color: white;
            font-size: 36px;
            font-weight: bold;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* ========== EVENT FEED ========== */
        #event-feed {
            position: absolute;
            bottom: 120px;
            left: 30px;
            width: 400px;
            z-index: 50;
        }

        .event-item {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 10px;
            color: white;
            font-size: 18px;
            border-left: 4px solid #3b82f6;
            animation: slideInLeft 0.4s ease-out;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .event-item.gift {
            border-left-color: #fbbf24;
        }

        .event-item.follow {
            border-left-color: #10b981;
        }

        .event-item.subscribe {
            border-left-color: #8b5cf6;
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .event-item .icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .event-item .username {
            font-weight: bold;
            color: #3b82f6;
        }

        /* ========== CHAT DISPLAY ========== */
        #chat-container {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 450px;
            max-height: 600px;
            z-index: 40;
        }

        .chat-message {
            background: rgba(0, 0, 0, 0.75);
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            animation: slideInRight 0.3s ease-out;
            backdrop-filter: blur(10px);
            word-wrap: break-word;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .chat-message .username {
            font-weight: bold;
            color: #fbbf24;
            margin-right: 8px;
        }

        .chat-message .message {
            color: #e5e7eb;
        }

        /* ========== GIFT ANIMATIONS ========== */
        @keyframes giftAnimIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes giftAnimOut {
            from {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            to {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }

        /* ========== GOAL BAR ========== */
        #goal-container {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 500px;
            z-index: 30;
            display: none;
        }

        #goal-container.show {
            display: block;
        }

        .goal-label {
            color: white;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        }

        .goal-bar {
            background: rgba(0, 0, 0, 0.7);
            height: 40px;
            border-radius: 20px;
            overflow: hidden;
            border: 3px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .goal-progress {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%);
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 15px;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        /* Fade-Out Animation f√ºr Chat und Events */
        .fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        /* ========== PATCH: VDO.NINJA MULTI-GUEST CONTAINER ========== */
        #vdoninja-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1; /* Behind all other overlay elements */
            display: none; /* Hidden by default */
        }

        #vdoninja-container.active {
            display: block;
        }

        #vdoninja-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
        }

        /* Guest Layout Overlays (for custom positioning) */
        .vdo-guest-frame {
            position: absolute;
            border: none;
            background: transparent;
            transition: all 0.3s ease;
        }

        /* Transition effects */
        .vdo-transition-fade {
            transition: opacity 0.5s ease;
        }

        .vdo-transition-slide {
            transition: transform 0.5s ease;
        }
    </style>
</head>
<body>

    <!-- PATCH: VDO.Ninja Multi-Guest Container -->
    <div id="vdoninja-container">
        <iframe id="vdoninja-iframe" src="" allow="camera; microphone; display-capture; autoplay; picture-in-picture" allowfullscreen></iframe>
    </div>

    <!-- Alert Display -->
    <div id="alert-container">
        <div id="alert-content">
            <img id="alert-image" src="" alt="">
            <div id="alert-text"></div>
        </div>
        <audio id="alert-sound"></audio>
    </div>

    <!-- Goal Bar -->
    <div id="goal-container">
        <div class="goal-label">
            Coins Goal: <span id="goal-current">0</span> / <span id="goal-target">1000</span>
        </div>
        <div class="goal-bar">
            <div class="goal-progress" id="goal-progress" style="width: 0%"></div>
        </div>
    </div>

    <!-- Event Feed -->
    <div id="event-feed"></div>

    <!-- Chat Display -->
    <div id="chat-container"></div>

    <!-- Audio Unlock Button (f√ºr Browser Autoplay Policy) -->
    <div id="audio-unlock" onclick="unlockAudio()">
        <span>üîä</span>
        <span>Audio aktivieren (Click here)</span>
    </div>

    <!-- Audio Element f√ºr TTS -->
    <audio id="tts-audio"></audio>

    <!-- Audio Pool f√ºr Soundboard -->
    <div id="soundboard-audio-pool"></div>

    <script>
        // Socket.io Verbindung
        const socket = io();

        // Soundboard Audio Queue
        let soundQueue = [];
        let isPlayingSound = false;
        let audioUnlocked = false;

        // Load HUD Configuration
        async function loadHudConfiguration() {
            try {
                const response = await fetch('/api/hud-config');
                const data = await response.json();

                if (data.success) {
                    // Apply resolution
                    if (data.resolution) {
                        const [width, height] = data.resolution.split('x').map(Number);
                        document.body.style.width = width + 'px';
                        document.body.style.height = height + 'px';

                        const viewport = document.querySelector('meta[name="viewport"]');
                        viewport.setAttribute('content', `width=${width}, height=${height}`);
                    }

                    // Apply element positions and visibility
                    data.elements.forEach(element => {
                        applyElementConfiguration(element);
                    });

                    console.log('‚úÖ HUD Configuration loaded');
                }
            } catch (error) {
                console.error('Error loading HUD configuration:', error);
            }
        }

        function applyElementConfiguration(config) {
            let elementId = '';

            // Map element_id to DOM element ID
            switch(config.element_id) {
                case 'alert':
                    elementId = 'alert-container';
                    break;
                case 'event-feed':
                    elementId = 'event-feed';
                    break;
                case 'chat':
                    elementId = 'chat-container';
                    break;
                case 'goal':
                    elementId = 'goal-container';
                    break;
                default:
                    return;
            }

            const element = document.getElementById(elementId);
            if (!element) return;

            // Apply visibility
            if (!config.enabled) {
                element.style.display = 'none';
                return;
            }

            // Apply size if configured
            if (config.width && config.width > 0) {
                element.style.width = config.width + 'px';
            }
            if (config.height && config.height > 0) {
                element.style.height = config.height + 'px';
            }

            // Apply position based on anchor
            const pos = config.position_x + config.position_unit;
            const posY = config.position_y + config.position_unit;

            // Reset all positioning
            element.style.top = 'auto';
            element.style.bottom = 'auto';
            element.style.left = 'auto';
            element.style.right = 'auto';
            element.style.transform = 'none';

            // Apply based on anchor
            switch(config.anchor) {
                case 'top-left':
                    element.style.top = posY;
                    element.style.left = pos;
                    break;
                case 'top-center':
                    element.style.top = posY;
                    element.style.left = pos;
                    element.style.transform = 'translateX(-50%)';
                    break;
                case 'top-right':
                    element.style.top = posY;
                    element.style.right = pos;
                    break;
                case 'center':
                    element.style.top = posY;
                    element.style.left = pos;
                    element.style.transform = 'translate(-50%, -50%)';
                    break;
                case 'bottom-left':
                    element.style.bottom = posY;
                    element.style.left = pos;
                    break;
                case 'bottom-center':
                    element.style.bottom = posY;
                    element.style.left = pos;
                    element.style.transform = 'translateX(-50%)';
                    break;
                case 'bottom-right':
                    element.style.bottom = posY;
                    element.style.right = pos;
                    break;
                default:
                    element.style.top = posY;
                    element.style.left = pos;
            }
        }

        // ========== AUDIO ENGINE (OBS-KOMPATIBEL) ==========
        let audioUnlocked = false;
        let audioContext = null;
        let masterGainNode = null;

        // Audio-Engine initialisieren (automatisch beim Laden)
        function initAudioEngine() {
            try {
                // AudioContext erstellen (funktioniert in OBS mit "Control audio via OBS")
                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContextClass();

                // Master Gain Node f√ºr Lautst√§rke-Kontrolle
                masterGainNode = audioContext.createGain();
                masterGainNode.connect(audioContext.destination);
                masterGainNode.gain.value = 1.0;

                console.log('üéµ Audio Engine initialized:', {
                    state: audioContext.state,
                    sampleRate: audioContext.sampleRate
                });

                // Versuche AudioContext zu starten (funktioniert in OBS automatisch)
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        console.log('‚úÖ AudioContext resumed automatically');
                        audioUnlocked = true;
                        hideAudioButton();
                    }).catch(err => {
                        console.warn('‚ö†Ô∏è AudioContext resume failed, user interaction needed:', err);
                        showAudioButton();
                    });
                } else {
                    audioUnlocked = true;
                    hideAudioButton();
                }

                // Stille Audio abspielen um Autoplay zu entsperren (OBS-Fallback)
                const silentBuffer = audioContext.createBuffer(1, 1, 22050);
                const source = audioContext.createBufferSource();
                source.buffer = silentBuffer;
                source.connect(audioContext.destination);
                source.start(0);

                return true;
            } catch (error) {
                console.error('‚ùå Audio Engine initialization failed:', error);
                showAudioButton();
                return false;
            }
        }

        // Audio Unlock Button verstecken
        function hideAudioButton() {
            const button = document.getElementById('audio-unlock');
            if (button) {
                button.classList.add('hidden');
            }
        }

        // Audio Unlock Button anzeigen
        function showAudioButton() {
            const button = document.getElementById('audio-unlock');
            if (button) {
                button.classList.remove('hidden');
            }
        }

        // Load configuration on page load
        loadHudConfiguration();

        // Audio Engine SOFORT beim Laden initialisieren
        initAudioEngine();

        // Audio Unlock (Browser Autoplay Policy umgehen) - nur f√ºr manuelle Browser
        function unlockAudio() {
            if (audioUnlocked) return;

            if (!audioContext) {
                initAudioEngine();
            }

            // AudioContext wieder aufnehmen
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    audioUnlocked = true;
                    const button = document.getElementById('audio-unlock');

                    // Show success feedback
                    button.innerHTML = '<span>‚úÖ</span><span>Audio aktiviert!</span>';
                    button.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';

                    console.log('‚úÖ Audio unlocked manually!');

                    // Hide button after 1 second
                    setTimeout(() => {
                        button.classList.add('hidden');
                    }, 1000);
                }).catch(err => {
                    console.warn('‚ö†Ô∏è Audio unlock failed:', err);

                    // Show error feedback
                    const button = document.getElementById('audio-unlock');
                    button.innerHTML = '<span>‚ùå</span><span>Fehler! Bitte erneut versuchen</span>';
                    button.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';

                    // Reset button after 2 seconds
                    setTimeout(() => {
                        button.innerHTML = '<span>üîä</span><span>Audio aktivieren (Click here)</span>';
                        button.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    }, 2000);
                });
            }
        }

        // State
        let goalTarget = 1000;
        let goalCurrent = 0;

        // ========== SOCKET LISTENERS ==========
        socket.on('connect', () => {
            console.log('‚úÖ Overlay connected to server');
        });

        // Alert anzeigen
        socket.on('alert:show', (data) => {
            showAlert(data);
        });

        // Alert verstecken
        socket.on('alert:hide', () => {
            hideAlert();
        });

        // TTS abspielen
        socket.on('tts:play', (data) => {
            playTTS(data);
        });

        // Soundboard abspielen
        socket.on('soundboard:play', (data) => {
            playSoundboardAudio(data);
        });

        // TikTok Events
        socket.on('tiktok:event', (event) => {
            handleEvent(event.type, event.data);
        });

        // Stats f√ºr Goal-Bar
        socket.on('tiktok:stats', (stats) => {
            updateGoal(stats.totalCoins);
        });

        // Gift Animation anzeigen
        socket.on('gift:animation', (data) => {
            showGiftAnimation(data);
        });

        // ========== ALERT FUNCTIONS ==========
        function showAlert(data) {
            const container = document.getElementById('alert-container');
            const text = document.getElementById('alert-text');
            const image = document.getElementById('alert-image');
            const sound = document.getElementById('alert-sound');

            // Text setzen
            text.textContent = data.text;

            // Bild setzen (optional)
            if (data.image) {
                image.src = data.image;
                image.classList.add('show');
            } else {
                image.classList.remove('show');
            }

            // Sound abspielen (optional)
            if (data.soundFile) {
                sound.src = `/assets/sounds/${data.soundFile}`;
                sound.volume = (data.soundVolume || 80) / 100;
                sound.play().catch(err => console.error('Sound playback error:', err));
            }

            // Alert anzeigen
            container.classList.remove('hide');
            container.classList.add('show');

            // Nach Dauer ausblenden
            setTimeout(() => {
                hideAlert();
            }, data.duration || 5000);
        }

        function hideAlert() {
            const container = document.getElementById('alert-container');
            container.classList.remove('show');
            container.classList.add('hide');

            setTimeout(() => {
                container.style.display = 'none';
                container.classList.remove('hide');
            }, 400);
        }

        // ========== TTS FUNCTIONS ==========
        function playTTS(data) {
            console.log('üé§ Playing TTS:', data.text);

            // Versuche Audio zu starten (funktioniert in OBS automatisch)
            if (!audioUnlocked && audioContext) {
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                audioUnlocked = true;
            }

            if (!audioUnlocked) {
                console.warn('‚ö†Ô∏è Audio engine not ready. Trying to initialize...');
                initAudioEngine();
            }

            const audio = document.getElementById('tts-audio');

            try {
                // Base64-Audio zu Blob konvertieren
                const audioData = data.audioData;
                const audioBlob = base64ToBlob(audioData, 'audio/mpeg');
                const audioUrl = URL.createObjectURL(audioBlob);

                audio.src = audioUrl;
                audio.volume = (data.volume || 80) / 100;
                audio.playbackRate = data.speed || 1.0;

                audio.play().then(() => {
                    console.log('‚úÖ TTS started playing');
                }).catch(err => {
                    console.error('‚ùå TTS playback error:', err);
                });

                // URL nach Abspielen freigeben
                audio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    console.log('‚úÖ TTS finished');
                };

                audio.onerror = (err) => {
                    console.error('‚ùå TTS audio error:', err);
                    URL.revokeObjectURL(audioUrl);
                };

            } catch (error) {
                console.error('‚ùå Error in playTTS:', error);
            }
        }

        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: mimeType });
        }

        // ========== SOUNDBOARD AUDIO ==========
        function playSoundboardAudio(data) {
            console.log('üîä Playing soundboard audio:', data.label);

            // Versuche Audio zu starten (funktioniert in OBS automatisch)
            if (!audioUnlocked && audioContext) {
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                audioUnlocked = true;
            }

            if (!audioUnlocked) {
                console.warn('‚ö†Ô∏è Audio engine not ready. Trying to initialize...');
                initAudioEngine();
            }

            // Create new audio element
            const audio = document.createElement('audio');
            audio.src = data.url;
            audio.volume = data.volume || 1.0;

            // Add to pool
            const pool = document.getElementById('soundboard-audio-pool');
            pool.appendChild(audio);

            // Remove after playback
            audio.onended = () => {
                console.log('‚úÖ Sound finished:', data.label);
                audio.remove();
                processSoundQueue();
            };

            audio.onerror = (e) => {
                console.error('‚ùå Error playing sound:', data.label, e);
                audio.remove();
                processSoundQueue();
            };

            // Play immediately (overlap mode)
            audio.play().then(() => {
                console.log('‚úÖ Sound started:', data.label);
            }).catch(err => {
                console.error('‚ùå Sound playback error:', data.label, err);
                audio.remove();
                processSoundQueue();
            });
        }

        function processSoundQueue() {
            if (soundQueue.length === 0) {
                isPlayingSound = false;
                return;
            }

            if (isPlayingSound) {
                return; // Still processing
            }

            isPlayingSound = true;
            const soundData = soundQueue.shift();
            playSoundboardAudio(soundData);
        }

        // ========== EVENT FEED ==========
        function handleEvent(type, data) {
            // Chat anzeigen
            if (type === 'chat') {
                addChatMessage(data);
            }

            // Event Feed (nur wichtige Events)
            if (['gift', 'follow', 'subscribe', 'share'].includes(type)) {
                addEventToFeed(type, data);
            }
        }

        // Hilfsfunktion zum Extrahieren des Benutzernamens mit Fallbacks
        function getUsername(data) {
            return data.username || data.uniqueId || data.nickname || 'Viewer';
        }

        function addEventToFeed(type, data) {
            const feed = document.getElementById('event-feed');

            const item = document.createElement('div');
            item.className = `event-item ${type}`;

            let icon = '';
            let text = '';
            const username = getUsername(data);

            switch (type) {
                case 'gift':
                    icon = 'üéÅ';
                    text = `<span class="username">${escapeHtml(username)}</span> sent ${escapeHtml(data.giftName)} x${escapeHtml(String(data.repeatCount))}`;
                    break;
                case 'follow':
                    icon = '‚≠ê';
                    text = `<span class="username">${escapeHtml(username)}</span> followed!`;
                    break;
                case 'subscribe':
                    icon = 'üåü';
                    text = `<span class="username">${escapeHtml(username)}</span> subscribed!`;
                    break;
                case 'share':
                    icon = 'üîÑ';
                    text = `<span class="username">${escapeHtml(username)}</span> shared the stream`;
                    break;
            }

            item.innerHTML = `<span class="icon">${icon}</span>${text}`;
            feed.insertBefore(item, feed.firstChild);

            // Nach 8 Sekunden ausblenden
            setTimeout(() => {
                item.classList.add('fade-out');
                setTimeout(() => item.remove(), 500);
            }, 8000);

            // Maximal 5 Events anzeigen
            while (feed.children.length > 5) {
                feed.removeChild(feed.lastChild);
            }
        }

        // ========== CHAT ==========
        function addChatMessage(data) {
            const container = document.getElementById('chat-container');

            const msg = document.createElement('div');
            msg.className = 'chat-message';
            const username = getUsername(data);
            msg.innerHTML = `
                <span class="username">${username}:</span>
                <span class="message">${escapeHtml(data.message)}</span>
            `;

            container.insertBefore(msg, container.firstChild);

            // Nach 15 Sekunden ausblenden
            setTimeout(() => {
                msg.classList.add('fade-out');
                setTimeout(() => msg.remove(), 500);
            }, 15000);

            // Maximal 10 Nachrichten
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== GIFT ANIMATIONS ==========
        function showGiftAnimation(data) {
            console.log('üé¨ Showing gift animation:', data);

            // Erstelle Animation-Container
            const container = document.createElement('div');
            container.id = 'gift-animation-' + Date.now();
            container.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 200;
                animation: giftAnimIn 0.5s ease-out;
            `;

            let content = '';
            const animationType = data.type || 'none';
            const animationUrl = data.url || '';
            const username = getUsername(data);

            if (animationType === 'image' || animationType === 'gif') {
                content = `
                    <div style="text-align: center;">
                        <img src="${animationUrl}"
                             style="max-width: 600px; max-height: 600px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);"
                             onerror="this.style.display='none'" />
                        <div style="margin-top: 20px; color: white; font-size: 28px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">
                            ${escapeHtml(username)} sent ${escapeHtml(data.giftName)}!
                        </div>
                    </div>
                `;
            } else if (animationType === 'video') {
                content = `
                    <div style="text-align: center;">
                        <video autoplay muted
                               style="max-width: 600px; max-height: 600px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);"
                               onended="this.parentElement.parentElement.remove()">
                            <source src="${animationUrl}" type="video/mp4">
                        </video>
                        <div style="margin-top: 20px; color: white; font-size: 28px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">
                            ${escapeHtml(username)} sent ${escapeHtml(data.giftName)}!
                        </div>
                    </div>
                `;
            } else {
                // Fallback: Show gift image from TikTok
                if (data.giftImage) {
                    content = `
                        <div style="text-align: center;">
                            <img src="${data.giftImage}"
                                 style="max-width: 400px; max-height: 400px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);"
                                 onerror="this.style.display='none'" />
                            <div style="margin-top: 20px; color: white; font-size: 28px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">
                                ${escapeHtml(username)} sent ${escapeHtml(data.giftName)}!
                            </div>
                        </div>
                    `;
                }
            }

            if (content) {
                container.innerHTML = content;
                document.body.appendChild(container);

                // Animation ausblenden und entfernen
                setTimeout(() => {
                    container.style.animation = 'giftAnimOut 0.5s ease-in';
                    setTimeout(() => container.remove(), 500);
                }, 4000); // 4 Sekunden anzeigen
            }
        }

        // ========== GOAL BAR ==========
        function updateGoal(current) {
            goalCurrent = current;

            document.getElementById('goal-current').textContent = current;
            const percentage = Math.min((current / goalTarget) * 100, 100);
            document.getElementById('goal-progress').style.width = percentage + '%';

            // Goal-Bar anzeigen wenn > 0 Coins
            const goalContainer = document.getElementById('goal-container');
            if (current > 0) {
                goalContainer.classList.add('show');
            }
        }

        // Optional: Goal-Target setzen (k√∂nnte √ºber Settings konfigurierbar sein)
        function setGoalTarget(target) {
            goalTarget = target;
            document.getElementById('goal-target').textContent = target;
        }

        // ========== PATCH: VDO.NINJA MULTI-GUEST OVERLAY CONTROL ==========

        const vdoOverlay = {
            container: null,
            iframe: null,
            isActive: false,
            currentLayout: 'Grid 2x2',
            guests: new Map()
        };

        // Initialize VDO.Ninja overlay
        function initVDONinja() {
            vdoOverlay.container = document.getElementById('vdoninja-container');
            vdoOverlay.iframe = document.getElementById('vdoninja-iframe');

            console.log('üé• VDO.Ninja Overlay initialized');
        }

        // Call init on load
        initVDONinja();

        // ========== SOCKET.IO LISTENERS FOR VDO.NINJA ==========

        socket.on('vdoninja:room-created', (data) => {
            console.log('üè† VDO.Ninja room created:', data);
            loadVDONinjaRoom(data.roomUrl);
        });

        socket.on('vdoninja:room-closed', () => {
            console.log('üîí VDO.Ninja room closed');
            closeVDONinjaRoom();
        });

        socket.on('vdoninja:guest-joined', (data) => {
            console.log('üë§ Guest joined:', data);
            vdoOverlay.guests.set(data.slot, data);
        });

        socket.on('vdoninja:guest-left', (data) => {
            console.log('üëã Guest left:', data);
            vdoOverlay.guests.delete(data.slot);
        });

        socket.on('vdoninja:control-guest', (data) => {
            console.log('üéõÔ∏è Controlling guest:', data);
            controlVDOGuest(data);
        });

        socket.on('vdoninja:solo-guest', (data) => {
            console.log('‚≠ê Solo guest:', data);
            soloVDOGuest(data);
        });

        socket.on('vdoninja:layout-changed', (data) => {
            console.log('üé® Layout changed:', data);
            changeVDOLayout(data);
        });

        socket.on('vdoninja:all-guests-muted', () => {
            console.log('üîá All guests muted');
            // Layout will be handled by individual control-guest events
        });

        socket.on('vdoninja:all-guests-unmuted', () => {
            console.log('üîä All guests unmuted');
            // Layout will be handled by individual control-guest events
        });

        // ========== VDO.NINJA ROOM CONTROL ==========

        function loadVDONinjaRoom(directorUrl) {
            if (!directorUrl) {
                console.error('‚ùå No director URL provided');
                return;
            }

            console.log('üì• Loading VDO.Ninja room:', directorUrl);

            vdoOverlay.iframe.src = directorUrl;
            vdoOverlay.container.classList.add('active');
            vdoOverlay.isActive = true;

            console.log('‚úÖ VDO.Ninja room loaded');
        }

        function closeVDONinjaRoom() {
            console.log('üîí Closing VDO.Ninja room');

            vdoOverlay.iframe.src = '';
            vdoOverlay.container.classList.remove('active');
            vdoOverlay.isActive = false;
            vdoOverlay.guests.clear();

            console.log('‚úÖ VDO.Ninja room closed');
        }

        // ========== VDO.NINJA GUEST CONTROL VIA POSTMESSAGE ==========

        /**
         * Control guest via VDO.Ninja postMessage API
         * Documentation: https://github.com/steveseguin/vdo.ninja/wiki/Advanced-Settings#api
         */
        function controlVDOGuest(data) {
            if (!vdoOverlay.isActive) {
                console.warn('‚ö†Ô∏è VDO.Ninja not active, cannot control guest');
                return;
            }

            const { slot, action, streamId } = data;

            // Map actions to VDO.Ninja API commands
            switch (action) {
                case 'mute':
                    if (data.muteAudio) {
                        sendVDOCommand({
                            action: 'muteGuest',
                            value: streamId || slot
                        });
                    }
                    if (data.muteVideo) {
                        sendVDOCommand({
                            action: 'hideGuest',
                            value: streamId || slot
                        });
                    }
                    break;

                case 'unmute':
                    if (data.unmuteAudio) {
                        sendVDOCommand({
                            action: 'unmuteGuest',
                            value: streamId || slot
                        });
                    }
                    if (data.unmuteVideo) {
                        sendVDOCommand({
                            action: 'showGuest',
                            value: streamId || slot
                        });
                    }
                    break;

                case 'volume':
                    sendVDOCommand({
                        action: 'volume',
                        value: data.volume,
                        target: streamId || slot
                    });
                    break;

                case 'kick':
                    sendVDOCommand({
                        action: 'hangup',
                        target: streamId || slot
                    });
                    break;

                default:
                    console.warn(`Unknown VDO.Ninja action: ${action}`);
            }
        }

        function soloVDOGuest(data) {
            const { slot, duration } = data;

            if (!vdoOverlay.isActive) {
                console.warn('‚ö†Ô∏è VDO.Ninja not active, cannot solo guest');
                return;
            }

            // Solo mode: Hide all guests except the soloed one
            vdoOverlay.guests.forEach((guest, guestSlot) => {
                if (guestSlot !== slot) {
                    sendVDOCommand({
                        action: 'hideGuest',
                        value: guest.streamId || guestSlot
                    });
                }
            });

            // If duration is set, restore after timeout
            if (duration > 0) {
                setTimeout(() => {
                    // Restore all guests
                    vdoOverlay.guests.forEach((guest, guestSlot) => {
                        if (guest.videoEnabled) {
                            sendVDOCommand({
                                action: 'showGuest',
                                value: guest.streamId || guestSlot
                            });
                        }
                    });
                }, duration);
            }
        }

        function changeVDOLayout(data) {
            const { layout, transition } = data;
            vdoOverlay.currentLayout = layout;

            // VDO.Ninja uses CSS Grid layouts via postMessage
            // We can send custom layout commands if needed
            console.log(`üé® Layout changed to: ${layout} (transition: ${transition})`);

            // Apply transition class
            if (transition === 'fade') {
                vdoOverlay.container.classList.add('vdo-transition-fade');
            } else if (transition === 'slide') {
                vdoOverlay.container.classList.add('vdo-transition-slide');
            }

            // Remove transition class after animation
            setTimeout(() => {
                vdoOverlay.container.classList.remove('vdo-transition-fade', 'vdo-transition-slide');
            }, 500);

            // Send layout command to VDO.Ninja
            // Note: VDO.Ninja layouts are typically controlled via URL parameters
            // For custom layouts, you would need to implement scene switching
            sendVDOCommand({
                action: 'changeScene',
                value: layout
            });
        }

        /**
         * Send postMessage command to VDO.Ninja iframe
         * @param {Object} command - Command object
         */
        function sendVDOCommand(command) {
            if (!vdoOverlay.iframe || !vdoOverlay.iframe.contentWindow) {
                console.error('‚ùå VDO.Ninja iframe not ready');
                return;
            }

            try {
                vdoOverlay.iframe.contentWindow.postMessage(command, '*');
                console.log('üì§ Sent VDO command:', command);
            } catch (error) {
                console.error('‚ùå Error sending VDO command:', error);
            }
        }

        // Listen for messages from VDO.Ninja iframe
        window.addEventListener('message', (event) => {
            // Only process messages from VDO.Ninja
            if (event.origin !== 'https://vdo.ninja') {
                return;
            }

            console.log('üì• Received message from VDO.Ninja:', event.data);

            // Handle VDO.Ninja events (e.g., guest joined, guest left)
            if (event.data.action) {
                handleVDOEvent(event.data);
            }
        });

        function handleVDOEvent(data) {
            // Handle events from VDO.Ninja iframe
            switch (data.action) {
                case 'connected':
                    console.log('‚úÖ VDO.Ninja connected');
                    break;
                case 'streamAdded':
                    console.log('üë§ Stream added:', data);
                    break;
                case 'streamRemoved':
                    console.log('üëã Stream removed:', data);
                    break;
                default:
                    console.log('VDO.Ninja event:', data);
            }
        }

        console.log('‚úÖ VDO.Ninja Overlay Control loaded');

    </script>

</body>
</html>
