<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=400, height=800">
    <title>TikTok Stream - OBS Dock</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 400px;
            min-height: 100vh;
            background: #1f2937;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            overflow-x: hidden;
        }

        /* Header */
        .dock-header {
            background: #111827;
            padding: 12px 16px;
            border-bottom: 2px solid #3b82f6;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .dock-header h1 {
            font-size: 18px;
            font-weight: bold;
            color: #3b82f6;
        }

        .dock-header .status {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 4px;
        }

        .dock-header .status.connected {
            color: #10b981;
        }

        .stats-compact {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            font-size: 12px;
            color: #9ca3af;
        }

        .stats-compact span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stats-compact span span {
            font-weight: bold;
            color: #3b82f6;
        }

        /* Section */
        .section {
            margin: 16px;
            background: #374151;
            border-radius: 8px;
            overflow: hidden;
        }

        .section-header {
            background: #4b5563;
            padding: 10px 12px;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-content {
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Chat Messages */
        .chat-item {
            margin-bottom: 10px;
            padding: 8px;
            background: #1f2937;
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
            animation: slideIn 0.3s ease-out;
        }

        .chat-username {
            font-weight: bold;
            color: #fbbf24;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .chat-message {
            color: #e5e7eb;
            font-size: 12px;
            word-wrap: break-word;
        }

        /* Gift Items */
        .gift-item {
            margin-bottom: 10px;
            padding: 8px;
            background: #1f2937;
            border-radius: 6px;
            border-left: 3px solid #fbbf24;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }

        .gift-icon {
            font-size: 24px;
        }

        .gift-info {
            flex: 1;
        }

        .gift-username {
            font-weight: bold;
            color: #fbbf24;
            font-size: 13px;
        }

        .gift-details {
            color: #9ca3af;
            font-size: 11px;
            margin-top: 2px;
        }

        .gift-coins {
            font-weight: bold;
            color: #fbbf24;
            font-size: 14px;
        }

        /* Follow/Join Items */
        .event-item {
            margin-bottom: 10px;
            padding: 8px;
            background: #1f2937;
            border-radius: 6px;
            border-left: 3px solid #10b981;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }

        .event-icon {
            font-size: 20px;
        }

        .event-info {
            flex: 1;
        }

        .event-username {
            font-weight: bold;
            color: #10b981;
            font-size: 13px;
        }

        .event-type {
            color: #9ca3af;
            font-size: 11px;
            margin-top: 2px;
        }

        .event-time {
            color: #6b7280;
            font-size: 10px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            color: #6b7280;
            font-size: 12px;
            padding: 20px;
        }

        /* Scrollbar */
        .section-content::-webkit-scrollbar {
            width: 6px;
        }

        .section-content::-webkit-scrollbar-track {
            background: #1f2937;
        }

        .section-content::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }

        .section-content::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Toggle Buttons */
        .toggle-section {
            cursor: pointer;
            user-select: none;
        }

        .section.collapsed .section-content {
            display: none;
        }

        .toggle-icon {
            transition: transform 0.2s;
        }

        .section.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        /* Config Panel */
        .config-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #111827;
            border-top: 2px solid #3b82f6;
            padding: 12px 16px;
        }

        .config-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .config-row label {
            font-size: 11px;
            color: #9ca3af;
            flex: 1;
        }

        .config-row input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
        }

        .action-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: 500;
        }

        .action-btn:hover {
            background: #2563eb;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        /* Leaderboard Items */
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #1f2937;
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .leaderboard-rank {
            font-weight: bold;
            color: #fbbf24;
            font-size: 14px;
            min-width: 20px;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-username {
            font-weight: bold;
            color: #e5e7eb;
            font-size: 12px;
        }

        .leaderboard-stats {
            color: #9ca3af;
            font-size: 10px;
            margin-top: 2px;
        }

        .leaderboard-value {
            font-weight: bold;
            color: #fbbf24;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="dock-header">
        <h1>üé• TikTok Stream Dock</h1>
        <div class="status" id="connection-status">‚ö´ Disconnected</div>
        <div class="stats-compact" id="stats-compact">
            <span>üë• <span id="viewer-count">0</span></span>
            <span>‚ù§Ô∏è <span id="like-count">0</span></span>
            <span>üéÅ <span id="gift-count">0</span></span>
        </div>
    </div>

    <!-- Chat Section -->
    <div class="section" id="chat-section">
        <div class="section-header toggle-section" onclick="toggleSection('chat')">
            <span class="toggle-icon">‚ñº</span>
            üí¨ Chat
        </div>
        <div class="section-content" id="chat-content">
            <div class="empty-state">Warte auf Chat-Nachrichten...</div>
        </div>
    </div>

    <!-- Gifts Section -->
    <div class="section" id="gifts-section">
        <div class="section-header toggle-section" onclick="toggleSection('gifts')">
            <span class="toggle-icon">‚ñº</span>
            üéÅ Geschenke
        </div>
        <div class="section-content" id="gifts-content">
            <div class="empty-state">Warte auf Geschenke...</div>
        </div>
    </div>

    <!-- Events Section (Follows, Joins) -->
    <div class="section" id="events-section">
        <div class="section-header toggle-section" onclick="toggleSection('events')">
            <span class="toggle-icon">‚ñº</span>
            ‚≠ê Events (Follows, Joins)
        </div>
        <div class="section-content" id="events-content">
            <div class="empty-state">Warte auf Events...</div>
        </div>
    </div>

    <!-- Quick Actions Section -->
    <div class="section" id="actions-section">
        <div class="section-header toggle-section" onclick="toggleSection('actions')">
            <span class="toggle-icon">‚ñº</span>
            ‚ö° Quick Actions
        </div>
        <div class="section-content" id="actions-content">
            <div class="quick-actions">
                <button class="action-btn" onclick="testTTS()">üîä TTS Test</button>
                <button class="action-btn" onclick="clearChat()">üóëÔ∏è Chat l√∂schen</button>
                <button class="action-btn" onclick="testAlert()">üîî Alert Test</button>
            </div>
        </div>
    </div>

    <!-- Leaderboard Section -->
    <div class="section" id="leaderboard-section">
        <div class="section-header toggle-section" onclick="toggleSection('leaderboard')">
            <span class="toggle-icon">‚ñº</span>
            üèÜ Top Gifters
        </div>
        <div class="section-content" id="leaderboard-content">
            <div class="empty-state">Keine Daten verf√ºgbar...</div>
        </div>
    </div>

    <!-- Config Panel -->
    <div class="config-panel">
        <div class="config-row">
            <label><input type="checkbox" id="show-chat" checked onchange="saveConfig()"> Chat anzeigen</label>
            <label><input type="checkbox" id="show-gifts" checked onchange="saveConfig()"> Geschenke anzeigen</label>
        </div>
        <div class="config-row">
            <label><input type="checkbox" id="show-events" checked onchange="saveConfig()"> Events anzeigen</label>
            <label><input type="checkbox" id="auto-clear" checked onchange="saveConfig()"> Auto-Clear (30s)</label>
        </div>
    </div>

    <script>
        const socket = io();

        // State
        let config = {
            showChat: true,
            showGifts: true,
            showEvents: true,
            showActions: true,
            showLeaderboard: true,
            autoClear: true
        };

        let stats = {
            viewerCount: 0,
            likeCount: 0,
            giftCount: 0
        };

        const MAX_ITEMS = 50; // Maximum Anzahl an Items pro Sektion
        const AUTO_CLEAR_DELAY = 30000; // 30 Sekunden

        // Load Config from LocalStorage
        function loadConfig() {
            const saved = localStorage.getItem('obs-dock-config');
            if (saved) {
                config = { ...config, ...JSON.parse(saved) };
                document.getElementById('show-chat').checked = config.showChat;
                document.getElementById('show-gifts').checked = config.showGifts;
                document.getElementById('show-events').checked = config.showEvents;
                document.getElementById('auto-clear').checked = config.autoClear;
            }
        }

        // Update Stats Display
        function updateStats() {
            document.getElementById('viewer-count').textContent = stats.viewerCount;
            document.getElementById('like-count').textContent = stats.likeCount;
            document.getElementById('gift-count').textContent = stats.giftCount;
        }

        // Save Config to LocalStorage
        function saveConfig() {
            config.showChat = document.getElementById('show-chat').checked;
            config.showGifts = document.getElementById('show-gifts').checked;
            config.showEvents = document.getElementById('show-events').checked;
            config.autoClear = document.getElementById('auto-clear').checked;
            localStorage.setItem('obs-dock-config', JSON.stringify(config));

            // Toggle Sections
            document.getElementById('chat-section').style.display = config.showChat ? 'block' : 'none';
            document.getElementById('gifts-section').style.display = config.showGifts ? 'block' : 'none';
            document.getElementById('events-section').style.display = config.showEvents ? 'block' : 'none';
        }

        // Quick Actions
        async function testTTS() {
            try {
                const response = await fetch('/api/tts/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: 'TikTok Stream Dock Test', voice: 'ghostface' })
                });
                if (response.ok) {
                    console.log('‚úÖ TTS Test erfolgreich');
                }
            } catch (error) {
                console.error('‚ùå TTS Test fehlgeschlagen:', error);
            }
        }

        function clearChat() {
            const container = document.getElementById('chat-content');
            container.innerHTML = '<div class="empty-state">Warte auf Chat-Nachrichten...</div>';
        }

        async function testAlert() {
            try {
                const response = await fetch('/api/alerts/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ eventType: 'gift' })
                });
                if (response.ok) {
                    console.log('‚úÖ Alert Test erfolgreich');
                }
            } catch (error) {
                console.error('‚ùå Alert Test fehlgeschlagen:', error);
            }
        }

        // Update Leaderboard
        function updateLeaderboard(data) {
            const container = document.getElementById('leaderboard-content');

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="empty-state">Keine Daten verf√ºgbar...</div>';
                return;
            }

            container.innerHTML = '';

            data.slice(0, 5).forEach((user, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.innerHTML = `
                    <div class="leaderboard-rank">#${index + 1}</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-username">${escapeHtml(user.username || 'Unknown')}</div>
                        <div class="leaderboard-stats">${user.gifts || 0} Geschenke</div>
                    </div>
                    <div class="leaderboard-value">${user.totalCoins || 0} üí∞</div>
                `;
                container.appendChild(item);
            });
        }

        // Toggle Section Collapse
        function toggleSection(section) {
            const sectionEl = document.getElementById(`${section}-section`);
            sectionEl.classList.toggle('collapsed');
        }

        // Add Chat Message
        function addChat(data) {
            if (!config.showChat) return;

            const container = document.getElementById('chat-content');

            // Remove empty state
            if (container.querySelector('.empty-state')) {
                container.innerHTML = '';
            }

            const item = document.createElement('div');
            item.className = 'chat-item';
            item.innerHTML = `
                <div class="chat-username">${escapeHtml(data.nickname || data.username || 'Viewer')}</div>
                <div class="chat-message">${escapeHtml(data.message || '')}</div>
            `;

            container.insertBefore(item, container.firstChild);

            // Limit Items
            while (container.children.length > MAX_ITEMS) {
                container.removeChild(container.lastChild);
            }

            // Auto Clear
            if (config.autoClear) {
                setTimeout(() => {
                    if (item.parentNode) {
                        item.remove();
                    }
                }, AUTO_CLEAR_DELAY);
            }
        }

        // Add Gift
        function addGift(data) {
            if (!config.showGifts) return;

            // Update gift stats
            stats.giftCount++;
            updateStats();

            const container = document.getElementById('gifts-content');

            // Remove empty state
            if (container.querySelector('.empty-state')) {
                container.innerHTML = '';
            }

            const item = document.createElement('div');
            item.className = 'gift-item';
            item.innerHTML = `
                <div class="gift-icon">üéÅ</div>
                <div class="gift-info">
                    <div class="gift-username">${escapeHtml(data.nickname || data.username || 'Viewer')}</div>
                    <div class="gift-details">${escapeHtml(data.giftName || 'Gift')} ${data.repeatCount > 1 ? 'x' + data.repeatCount : ''}</div>
                </div>
                <div class="gift-coins">${data.coins || 0} üí∞</div>
            `;

            container.insertBefore(item, container.firstChild);

            // Limit Items
            while (container.children.length > MAX_ITEMS) {
                container.removeChild(container.lastChild);
            }

            // Auto Clear
            if (config.autoClear) {
                setTimeout(() => {
                    if (item.parentNode) {
                        item.remove();
                    }
                }, AUTO_CLEAR_DELAY);
            }
        }

        // Add Event (Follow, Subscribe, Share, Join)
        function addEvent(type, data) {
            if (!config.showEvents) return;

            const container = document.getElementById('events-content');

            // Remove empty state
            if (container.querySelector('.empty-state')) {
                container.innerHTML = '';
            }

            const icons = {
                follow: '‚≠ê',
                subscribe: 'üíé',
                share: 'üîó',
                join: 'üëã'
            };

            const labels = {
                follow: 'Folgt jetzt',
                subscribe: 'Hat abonniert',
                share: 'Hat geteilt',
                join: 'Ist beigetreten'
            };

            const item = document.createElement('div');
            item.className = 'event-item';
            item.innerHTML = `
                <div class="event-icon">${icons[type] || '‚≠ê'}</div>
                <div class="event-info">
                    <div class="event-username">${escapeHtml(data.nickname || data.username || 'Viewer')}</div>
                    <div class="event-type">${labels[type] || 'Event'}</div>
                </div>
                <div class="event-time">${new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}</div>
            `;

            container.insertBefore(item, container.firstChild);

            // Limit Items
            while (container.children.length > MAX_ITEMS) {
                container.removeChild(container.lastChild);
            }

            // Auto Clear
            if (config.autoClear) {
                setTimeout(() => {
                    if (item.parentNode) {
                        item.remove();
                    }
                }, AUTO_CLEAR_DELAY);
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Socket.IO Listeners
        socket.on('tiktok:status', (data) => {
            const statusEl = document.getElementById('connection-status');
            if (data.status === 'connected') {
                statusEl.textContent = `üü¢ Connected: @${data.username || ''}`;
                statusEl.classList.add('connected');
            } else {
                statusEl.textContent = '‚ö´ Disconnected';
                statusEl.classList.remove('connected');
            }
        });

        socket.on('tiktok:event', (event) => {
            const { type, data } = event;

            switch (type) {
                case 'chat':
                    addChat(data);
                    break;
                case 'gift':
                    addGift(data);
                    break;
                case 'follow':
                    addEvent('follow', data);
                    break;
                case 'subscribe':
                    addEvent('subscribe', data);
                    break;
                case 'share':
                    addEvent('share', data);
                    break;
            }
        });

        socket.on('tiktok:connected', (data) => {
            console.log('‚úÖ TikTok connected:', data);
        });

        socket.on('tiktok:stats', (data) => {
            if (data.viewerCount !== undefined) stats.viewerCount = data.viewerCount;
            if (data.likeCount !== undefined) stats.likeCount = data.likeCount;
            updateStats();
        });

        socket.on('tiktok:like', (data) => {
            stats.likeCount += (data.likeCount || 1);
            updateStats();
        });

        socket.on('leaderboard:update', (data) => {
            if (data.type === 'gifters') {
                updateLeaderboard(data.leaderboard);
            }
        });

        // Fetch initial leaderboard data
        async function fetchLeaderboard() {
            try {
                const response = await fetch('/api/leaderboard/gifters');
                if (response.ok) {
                    const data = await response.json();
                    updateLeaderboard(data);
                }
            } catch (error) {
                console.error('‚ùå Leaderboard fetch failed:', error);
            }
        }

        // Fetch leaderboard every 30 seconds
        setInterval(fetchLeaderboard, 30000);

        // Initialization
        loadConfig();
        saveConfig(); // Apply initial config
        fetchLeaderboard(); // Load initial leaderboard data

        console.log('‚úÖ OBS Dock initialized');
    </script>
</body>
</html>
