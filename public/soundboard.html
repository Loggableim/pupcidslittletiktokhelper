<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TikTok LIVE Soundboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    /* Apple-inspired Design */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    .dot { width: 12px; height: 12px; border-radius: 9999px; }
    .scroll-shadow { box-shadow: inset 0 -12px 12px -12px rgba(0,0,0,0.15); }
    .tab-btn { transition: all 0.2s; }
    .tab-btn[aria-selected="true"]{ background:#0ea5e9; color: white; }
    .gift-row:hover { background: rgba(148,163,184,.08); }
    .gift-row.assigned { background: rgba(14, 165, 233, 0.1); border-color: rgba(14, 165, 233, 0.3); }

    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .animate-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    /* Light Mode */
    .light-mode {
      background: #f5f5f7;
      color: #1d1d1f;
    }
    .light-mode .bg-slate-950 { background: #ffffff !important; }
    .light-mode .bg-slate-900 { background: #f5f5f7 !important; }
    .light-mode .bg-slate-800 { background: #e8e8ed !important; }
    .light-mode .bg-slate-700 { background: #d2d2d7 !important; }
    .light-mode .text-slate-100 { color: #1d1d1f !important; }
    .light-mode .text-slate-300 { color: #6e6e73 !important; }
    .light-mode .text-slate-400 { color: #86868b !important; }
    .light-mode .border-slate-800 { border-color: #d2d2d7 !important; }
    .light-mode .border-slate-700 { border-color: #d2d2d7 !important; }

    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #1f2937;
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      z-index: 9999;
      animation: slideInRight 0.3s ease-out;
    }
    .light-mode .toast {
      background: #ffffff;
      color: #1d1d1f;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    @keyframes slideInRight {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-100">
  <div class="max-w-7xl mx-auto p-4 md:p-8">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl md:text-3xl font-semibold">üéµ TikTok LIVE Soundboard</h1>
      <div class="flex items-center gap-3">
        <div id="statusDot" class="dot bg-red-500"></div>
        <span id="statusText" class="text-sm text-slate-300">offline</span>
        <button id="themeToggle" class="rounded-lg bg-slate-700 hover:bg-slate-600 px-3 py-2 text-sm" title="Tag/Nacht umschalten">üåó</button>
      </div>
    </header>

    <!-- Connection Section -->
    <section class="mt-6 grid md:grid-cols-3 gap-4">
      <div class="col-span-2 bg-slate-900/60 border border-slate-800 rounded-2xl p-4">
        <h2 class="font-semibold mb-3">Verbindung</h2>
        <form class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm mb-1">TikTok @user</label>
            <input id="tiktok_user" placeholder="@deinname"
                   class="w-full rounded-xl bg-slate-800 border border-slate-700 px-3 py-2" />
          </div>
          <div class="flex items-end gap-2">
            <button id="btnConnect" type="button" class="rounded-xl bg-emerald-600 hover:bg-emerald-500 px-4 py-2 font-medium">Verbinden</button>
            <button id="btnDisconnect" type="button" class="rounded-xl bg-rose-600 hover:bg-rose-500 px-4 py-2 font-medium">Trennen</button>
            <button id="btnUpdateGifts" type="button" class="rounded-xl bg-sky-600 hover:bg-sky-500 px-4 py-2 font-medium">Gifts aktualisieren</button>
          </div>
        </form>
        <div class="mt-2">
          <span id="giftStatus" class="text-sm text-slate-400"></span>
        </div>
      </div>

      <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4">
        <h2 class="font-semibold mb-3">Audio-Test</h2>
        <div class="space-y-2">
          <input id="test_url" placeholder="MP3-URL zum Testen" class="w-full rounded-xl bg-slate-800 border border-slate-700 px-3 py-2" />
          <button id="btnTest" class="w-full rounded-xl bg-indigo-600 hover:bg-indigo-500 px-4 py-2 font-medium">Abspielen</button>
        </div>
      </div>
    </section>

    <!-- Event Sounds & Playback Settings -->
    <section class="mt-6 grid lg:grid-cols-2 gap-4">
      <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4">
        <h3 class="font-semibold mb-3">Event-Sounds & Wiedergabe</h3>
        <div class="space-y-4">
          <!-- Follow Sound -->
          <div>
            <label class="block text-sm mb-1">Follow-Sound</label>
            <div class="flex gap-2 items-center">
              <input id="follow_sound" placeholder="MP3-URL"
                     class="flex-1 rounded-xl bg-slate-800 border border-slate-700 px-3 py-2" />
              <input id="follow_volume" type="range" min="0" max="1" step="0.05" value="1.0" class="w-20" title="Lautst√§rke" />
              <button class="rounded-xl bg-amber-600 hover:bg-amber-500 px-3 py-2" onclick="previewSound('follow_sound', 'follow_volume', 'Follow')">‚ñ∂</button>
              <button class="rounded-xl bg-sky-600 hover:bg-sky-500 px-3 py-2" onclick="openPicker('follow_sound')">Picker</button>
            </div>
          </div>

          <!-- Subscribe Sound -->
          <div>
            <label class="block text-sm mb-1">Subscribe-Sound</label>
            <div class="flex gap-2 items-center">
              <input id="subscribe_sound" placeholder="MP3-URL"
                     class="flex-1 rounded-xl bg-slate-800 border border-slate-700 px-3 py-2" />
              <input id="subscribe_volume" type="range" min="0" max="1" step="0.05" value="1.0" class="w-20" title="Lautst√§rke" />
              <button class="rounded-xl bg-amber-600 hover:bg-amber-500 px-3 py-2" onclick="previewSound('subscribe_sound', 'subscribe_volume', 'Subscribe')">‚ñ∂</button>
              <button class="rounded-xl bg-sky-600 hover:bg-sky-500 px-3 py-2" onclick="openPicker('subscribe_sound')">Picker</button>
            </div>
          </div>

          <!-- Share Sound -->
          <div>
            <label class="block text-sm mb-1">Share-Sound</label>
            <div class="flex gap-2 items-center">
              <input id="share_sound" placeholder="MP3-URL"
                     class="flex-1 rounded-xl bg-slate-800 border border-slate-700 px-3 py-2" />
              <input id="share_volume" type="range" min="0" max="1" step="0.05" value="1.0" class="w-20" title="Lautst√§rke" />
              <button class="rounded-xl bg-amber-600 hover:bg-amber-500 px-3 py-2" onclick="previewSound('share_sound', 'share_volume', 'Share')">‚ñ∂</button>
              <button class="rounded-xl bg-sky-600 hover:bg-sky-500 px-3 py-2" onclick="openPicker('share_sound')">Picker</button>
            </div>
          </div>

          <!-- Like Settings -->
          <div class="grid sm:grid-cols-3 gap-2">
            <div>
              <label class="block text-sm mb-1">Like-Schwelle</label>
              <input id="like_threshold" type="number" min="0" value="20" class="w-full rounded-xl bg-slate-800 border border-slate-700 px-3 py-2" />
            </div>
            <div>
              <label class="block text-sm mb-1">Zeitraum (Sek.)</label>
              <input id="like_window_seconds" type="number" min="1" value="10" class="w-full rounded-xl bg-slate-800 border border-slate-700 px-3 py-2" />
            </div>
            <div class="flex flex-col gap-1">
              <label class="block text-sm mb-1">Like-Sound</label>
              <div class="flex gap-2 items-center">
                <input id="like_sound" placeholder="MP3-URL" class="flex-1 rounded-xl bg-slate-800 border border-slate-700 px-3 py-2" />
                <input id="like_volume" type="range" min="0" max="1" step="0.05" value="1.0" class="w-20" title="Lautst√§rke" />
              </div>
              <div class="flex gap-2">
                <button class="rounded-lg bg-amber-600 hover:bg-amber-500 px-3 py-1.5" onclick="previewSound('like_sound', 'like_volume', 'Like')">‚ñ∂</button>
                <button class="rounded-lg bg-sky-600 hover:bg-sky-500 px-3 py-1.5" onclick="openPicker('like_sound')">Picker</button>
              </div>
            </div>
          </div>

          <!-- Default Gift Sound -->
          <div class="border-t border-slate-800 pt-4">
            <label class="block text-sm mb-1">Standard-Gift-Sound (f√ºr nicht zugeordnete Gifts)</label>
            <div class="flex gap-2 items-center">
              <input id="default_gift_sound" placeholder="MP3-URL"
                     class="flex-1 rounded-xl bg-slate-800 border border-slate-700 px-3 py-2" />
              <input id="default_gift_volume" type="range" min="0" max="1" step="0.05" value="1.0" class="w-20" title="Lautst√§rke" />
              <button class="rounded-xl bg-amber-600 hover:bg-amber-500 px-3 py-2" onclick="previewSound('default_gift_sound', 'default_gift_volume', 'Default Gift')">‚ñ∂</button>
              <button class="rounded-xl bg-sky-600 hover:bg-sky-500 px-3 py-2" onclick="openPicker('default_gift_sound')">Picker</button>
            </div>
            <p class="text-xs text-slate-400 mt-1">Dieser Sound wird f√ºr alle Gifts abgespielt, die keine spezielle Zuordnung haben.</p>
          </div>

          <!-- Playback Settings -->
          <div class="grid sm:grid-cols-3 gap-2 border-t border-slate-800 pt-4">
            <div>
              <label class="block text-sm mb-1">Queue‚ÄëL√§nge</label>
              <input id="queue_length" type="number" min="1" value="10" class="w-full rounded-xl bg-slate-800 border border-slate-700 px-3 py-2" />
            </div>
            <div>
              <label class="block text-sm mb-1">Wiedergabe-Modus</label>
              <select id="play_mode" class="w-full rounded-xl bg-slate-800 border border-slate-700 px-3 py-2">
                <option value="overlap">√úberlappend</option>
                <option value="sequential">Nacheinander</option>
              </select>
            </div>
          </div>

          <div class="flex justify-end gap-2">
            <button id="btnReset" class="rounded-xl bg-slate-700 hover:bg-slate-600 px-4 py-2 font-medium" title="√Ñnderungen verwerfen">Reset</button>
            <label for="importFile" class="rounded-xl bg-purple-700 hover:bg-purple-600 px-4 py-2 font-medium cursor-pointer">Import</label>
            <input type="file" id="importFile" accept="application/json" class="hidden" />
            <button id="btnExport" class="rounded-xl bg-sky-700 hover:bg-sky-600 px-4 py-2 font-medium">Export</button>
            <button id="btnSaveAll" class="rounded-xl bg-emerald-600 hover:bg-emerald-500 px-4 py-2 font-medium">Alles speichern</button>
          </div>
        </div>
      </div>

      <!-- Gifts ‚Üí Audio -->
      <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4">
        <h3 class="font-semibold mb-3">Geschenke ‚Üí Audio</h3>
        <div class="flex flex-wrap items-center gap-2 mb-3">
          <input id="giftSearch" placeholder="Geschenk suchen ‚Ä¶ (Name oder ID)"
                 class="rounded-xl bg-slate-800 border border-slate-700 px-3 py-2 flex-1 min-w-[220px]" />
          <label class="text-sm text-slate-300">Sortierung:</label>
          <select id="giftSort" class="rounded-xl bg-slate-800 border border-slate-700 px-3 py-2">
            <option value="desc">Preis absteigend</option>
            <option value="asc">Preis aufsteigend</option>
          </select>
        </div>

        <!-- Bulk Actions Toolbar -->
        <div id="bulkToolbar" class="hidden bg-sky-900/30 border border-sky-700/50 rounded-xl p-2 mb-3">
          <div class="flex items-center gap-2 flex-wrap">
            <span id="bulkCount" class="text-sm font-medium">0 ausgew√§hlt</span>
            <button id="btnBulkAssign" class="rounded-lg bg-sky-600 hover:bg-sky-500 px-3 py-1 text-sm">Sound zuweisen</button>
            <button id="btnBulkClear" class="rounded-lg bg-rose-600 hover:bg-rose-500 px-3 py-1 text-sm">L√∂schen</button>
            <button id="btnBulkSelectAll" class="rounded-lg bg-slate-700 hover:bg-slate-600 px-3 py-1 text-sm">Alle</button>
            <button id="btnBulkSelectNone" class="rounded-lg bg-slate-700 hover:bg-slate-600 px-3 py-1 text-sm">Keine</button>
            <button id="btnBulkSelectAssigned" class="rounded-lg bg-slate-700 hover:bg-slate-600 px-3 py-1 text-sm">Zugeordnete</button>
          </div>
        </div>

        <div id="giftList" class="max-h-[32rem] overflow-y-auto pr-1 scroll-shadow space-y-2"></div>
        <p class="text-xs text-slate-400 mt-2">Nur Gifts mit gesetzter MP3 werden gespeichert. <span class="text-sky-400">Tipp: Strg+Z/Y f√ºr Undo/Redo</span></p>
      </div>
    </section>

    <!-- Live Log & Info -->
    <section class="mt-6 grid lg:grid-cols-2 gap-4">
      <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4">
        <h3 class="font-semibold mb-3">Live-Log</h3>
        <pre id="log" class="h-72 overflow-y-auto bg-black/40 rounded-xl p-3 text-xs"></pre>
      </div>
      <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4">
        <h3 class="font-semibold mb-3">Hinweise</h3>
        <ul class="text-sm list-disc pl-5 space-y-2 text-slate-300">
          <li>OBS: Diese Seite als Browserquelle einbinden f√ºr Audioausgabe.</li>
          <li>Gift-Liste ist nach Diamond-Preis sortierbar und per Text filterbar.</li>
          <li>Audio-Auswahl per Picker-Dialog. Alternativ direkte MP3-URL einf√ºgen.</li>
          <li>Live-Updates via WebSocket f√ºr Echtzeit-Synchronisation.</li>
          <li><a href="/dashboard.html" class="text-sky-400 hover:underline">Zum Dashboard ‚Üí</a></li>
        </ul>
      </div>
    </section>
  </div>

  <!-- Picker Modal -->
  <div id="picker" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-50">
    <div class="bg-slate-900 w-full max-w-5xl h-[80vh] rounded-2xl border border-slate-800 p-4 flex flex-col">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2 flex-wrap">
          <button class="tab-btn rounded-lg px-3 py-2 bg-slate-800" aria-selected="true" onclick="switchTab('browse')">Browser</button>
          <button class="tab-btn rounded-lg px-3 py-2 bg-slate-800" aria-selected="false" onclick="switchTab('search')">üîç Suche</button>
          <button class="tab-btn rounded-lg px-3 py-2 bg-slate-800" aria-selected="false" onclick="switchTab('favorites')">‚≠ê Favoriten</button>
          <button class="tab-btn rounded-lg px-3 py-2 bg-slate-800" aria-selected="false" onclick="switchTab('search')">Suche</button>
          <button class="tab-btn rounded-lg px-3 py-2 bg-slate-800" aria-selected="false" onclick="switchTab('trending')">üî• Trending</button>
          <button class="tab-btn rounded-lg px-3 py-2 bg-slate-800" aria-selected="false" onclick="switchTab('random')">üé≤ Zufall</button>
        </div>
        <button onclick="closePicker()" class="text-slate-300 hover:text-white text-xl">‚úï</button>
      </div>

      <!-- Browser Tab -->
      <div class="flex-1 flex flex-col gap-3" id="tab-browse">
        <div class="flex gap-2">
          <input id="miUrl" placeholder="MyInstants-URL einf√ºgen & aufl√∂sen"
                 class="flex-1 rounded-xl bg-slate-800 border border-slate-700 px-3 py-2" />
          <button id="btnResolve" class="rounded-xl bg-emerald-600 hover:bg-emerald-500 px-3 py-2">Seite ‚Üí MP3</button>
          <button id="btnUse" class="rounded-xl bg-sky-600 hover:bg-sky-500 px-3 py-2">√úbernehmen</button>
        </div>
        <iframe id="miFrame" src="https://www.myinstants.com" class="w-full h-full rounded-xl border border-slate-700"></iframe>
      </div>

      <!-- Search Tab -->
      <div class="flex-1 flex-col gap-3 hidden" id="tab-search">
        <div class="flex gap-2 mb-3">
          <input id="searchQuery" placeholder="Live-Suche (tippe zum Suchen)..."
                 class="flex-1 rounded-xl bg-slate-800 border border-slate-700 px-3 py-2" />
          <button id="btnSearch" class="rounded-xl bg-sky-600 hover:bg-sky-500 px-3 py-2">üîç Suchen</button>
          <button id="btnClearCache" class="rounded-xl bg-slate-700 hover:bg-slate-600 px-3 py-2" title="Cache leeren">üóëÔ∏è</button>
        </div>
        <div class="mb-2">
          <div class="text-xs text-slate-400 mb-2">üè∑Ô∏è Beliebte Kategorien:</div>
          <div class="flex flex-wrap gap-1" id="popularCategories">
            <button class="px-3 py-1 rounded-full bg-slate-700 hover:bg-sky-600 text-xs transition-colors" onclick="filterByCategory('meme')">meme</button>
            <button class="px-3 py-1 rounded-full bg-slate-700 hover:bg-sky-600 text-xs transition-colors" onclick="filterByCategory('funny')">funny</button>
            <button class="px-3 py-1 rounded-full bg-slate-700 hover:bg-sky-600 text-xs transition-colors" onclick="filterByCategory('music')">music</button>
            <button class="px-3 py-1 rounded-full bg-slate-700 hover:bg-sky-600 text-xs transition-colors" onclick="filterByCategory('sound effect')">sound effect</button>
            <button class="px-3 py-1 rounded-full bg-slate-700 hover:bg-sky-600 text-xs transition-colors" onclick="filterByCategory('anime')">anime</button>
            <button class="px-3 py-1 rounded-full bg-slate-700 hover:bg-sky-600 text-xs transition-colors" onclick="filterByCategory('gaming')">gaming</button>
            <button class="px-3 py-1 rounded-full bg-slate-700 hover:bg-sky-600 text-xs transition-colors" onclick="filterByCategory('movie')">movie</button>
          </div>
        </div>
        <div id="searchResults" class="overflow-y-auto flex-1 space-y-2"></div>
      </div>

      <!-- Favorites Tab -->
      <div class="flex-1 flex-col gap-3 hidden" id="tab-favorites">
        <div class="flex gap-2 mb-3 justify-between items-center">
          <h3 class="text-lg font-semibold">‚≠ê Deine Favoriten</h3>
          <button id="btnClearFavorites" class="rounded-xl bg-rose-600 hover:bg-rose-500 px-3 py-2">Alle l√∂schen</button>
        </div>
        <div id="favoritesResults" class="overflow-y-auto flex-1 space-y-2"></div>
      </div>

          <input id="searchQuery" placeholder="Suchbegriff eingeben..."
                 class="flex-1 rounded-xl bg-slate-800 border border-slate-700 px-3 py-2" />
          <button id="btnSearch" class="rounded-xl bg-sky-600 hover:bg-sky-500 px-3 py-2">üîç Suchen</button>
        </div>
        <div id="searchResults" class="overflow-y-auto flex-1 space-y-2"></div>
      </div>

      <!-- Trending Tab -->
      <div class="flex-1 flex-col gap-3 hidden" id="tab-trending">
        <div class="flex gap-2 mb-3 justify-between items-center">
          <h3 class="text-lg font-semibold">üî• Trending Sounds</h3>
          <button id="btnLoadTrending" class="rounded-xl bg-sky-600 hover:bg-sky-500 px-3 py-2">Aktualisieren</button>
        </div>
        <div id="trendingResults" class="overflow-y-auto flex-1 space-y-2"></div>
      </div>

      <!-- Random Tab -->
      <div class="flex-1 flex-col gap-3 hidden" id="tab-random">
        <div class="flex gap-2 mb-3 justify-between items-center">
          <h3 class="text-lg font-semibold">üé≤ Zuf√§llige Sounds</h3>
          <button id="btnLoadRandom" class="rounded-xl bg-sky-600 hover:bg-sky-500 px-3 py-2">Neu laden</button>
        </div>
        <div id="randomResults" class="overflow-y-auto flex-1 space-y-2"></div>
      </div>
    </div>
  </div>

  <script>
    // ========== WebSocket & State ==========
    const socket = io();
    let catalog = [];
    let assignments = {};
    let pickerTarget = null;

    // ========== NEW: Advanced Features ==========
    // API Cache
    const apiCache = new Map();
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

    // Favoriten (LocalStorage)
    let favorites = JSON.parse(localStorage.getItem('soundFavorites') || '[]');

    // Undo/Redo History
    let history = [];
    let historyIndex = -1;
    const MAX_HISTORY = 50;

    // Auto-Save
    let hasUnsavedChanges = false;
    let autoSaveInterval = null;

    // Debounce Timer
    let searchDebounceTimer = null;

    // Pagination
    let currentSearchPage = 1;
    let currentSearchQuery = '';

    // ========== Connection & Status ==========
    socket.on('tiktok:status', (data) => {
      const connected = data.status === 'connected';
      setStatus(connected);

      // Update username field when connection status changes
      if (data.username) {
        document.getElementById('tiktok_user').value = data.username;
      }

      if (connected && data.username) {
        showToast(`Verbunden mit @${data.username}`);
      }
    });

    socket.on('gift_catalog:updated', (data) => {
      showToast(`Gift-Katalog aktualisiert: ${data.count} Eintr√§ge`);
      loadCatalog();
    });

    socket.on('soundboard:play', (data) => {
      playSound(data.url, data.volume, data.label);
    });

    function setStatus(ok) {
      document.getElementById('statusDot').classList.toggle('bg-emerald-500', ok);
      document.getElementById('statusDot').classList.toggle('bg-red-500', !ok);
      document.getElementById('statusText').textContent = ok ? 'online' : 'offline';
    }

    // ========== Logging ==========
    const logEl = document.getElementById('log');
    function pushLog(line) {
      const atBottom = Math.abs(logEl.scrollHeight - logEl.scrollTop - logEl.clientHeight) < 5;
      logEl.textContent += line + "\n";
      if (atBottom) logEl.scrollTop = logEl.scrollHeight;
    }

    // ========== Toast Notifications ==========
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
      pushLog(message);
    }

    // ========== Audio Playback ==========
    let audioQueue = [];
    let activeAudio = [];

    function playSound(url, vol, label) {
      pushLog(`üéµ PLAY ‚ñ∂ ${label || ''} | ${url}`);
      const mode = document.getElementById('play_mode')?.value || 'overlap';
      const maxLen = Number(document.getElementById('queue_length')?.value || 10);

      if (mode === 'sequential') {
        audioQueue.push({ url, vol: Number(vol) });
        while (audioQueue.length > maxLen) audioQueue.shift();
        processQueue();
      } else {
        // Overlap mode
        const duplicateActive = activeAudio.some(a => a.src === url && !a.paused);
        if (duplicateActive) {
          audioQueue.push({ url, vol: Number(vol) });
          while (audioQueue.length > maxLen) audioQueue.shift();
          processQueue();
          return;
        }
        const a = new Audio(url);
        a.volume = Number(vol || 1);
        a.play().catch(e => pushLog('‚ùå Audio Error: ' + e));
        activeAudio.push(a);
        a.onended = () => {
          activeAudio = activeAudio.filter(aud => aud !== a);
          processQueue();
        };
        while (activeAudio.length > maxLen) {
          const old = activeAudio.shift();
          if (old) old.pause();
        }
      }
    }

    let isProcessingQueue = false;
    async function processQueue() {
      if (isProcessingQueue || audioQueue.length === 0) return;
      isProcessingQueue = true;
      const item = audioQueue.shift();
      const a = new Audio(item.url);
      a.volume = item.vol;
      a.onended = () => { isProcessingQueue = false; processQueue(); };
      a.onerror = () => { isProcessingQueue = false; processQueue(); pushLog('‚ùå Audio Error'); };
      try {
        await a.play();
      } catch (e) {
        pushLog('‚ùå Audio Error: ' + e);
        isProcessingQueue = false;
        processQueue();
      }
    }

    // ========== API Calls ==========
    async function apiCall(url, method = 'GET', body = null) {
      const opts = { method, headers: { 'Content-Type': 'application/json' } };
      if (body) opts.body = JSON.stringify(body);
      const res = await fetch(url, opts);
      return await res.json();
    }

    document.getElementById('btnConnect').onclick = async () => {
      const username = document.getElementById('tiktok_user').value.trim();
      if (!username) return showToast('Bitte TikTok-Username eingeben');
      const result = await apiCall('/api/connect', 'POST', { username });
      if (result.success) {
        showToast('Verbinde...');
      } else {
        showToast('Fehler: ' + result.error);
      }
    };

    document.getElementById('btnDisconnect').onclick = async () => {
      await apiCall('/api/disconnect', 'POST');
      showToast('Verbindung getrennt');
    };

    document.getElementById('btnUpdateGifts').onclick = async () => {
      document.getElementById('giftStatus').textContent = 'Aktualisiere‚Ä¶';
      const result = await apiCall('/api/gift-catalog/update', 'POST');
      document.getElementById('giftStatus').textContent = result.message || (result.ok ? 'OK' : 'Fehler');
      if (result.ok) loadCatalog();
    };

    document.getElementById('btnTest').onclick = () => {
      const url = document.getElementById('test_url').value.trim();
      if (url) playSound(url, 1.0, 'Test');
    };

    // ========== Gift Catalog & Assignments ==========
    async function loadCatalog() {
      const result = await apiCall('/api/gift-catalog');
      if (result.success) {
        catalog = result.catalog;
        document.getElementById('giftStatus').textContent = `${catalog.length} Gifts verf√ºgbar`;

        // Lade gespeicherte Gift-Sounds
        const soundsResult = await apiCall('/api/soundboard/gifts');
        if (soundsResult) {
          soundsResult.forEach(s => {
            assignments[s.giftId] = {
              mp3_url: s.mp3Url || '',
              label: s.label || '',
              volume: s.volume ?? 1.0
            };
          });
        }

        renderGiftList();
      }
    }

    function renderGiftList() {
      const q = document.getElementById('giftSearch').value.toLowerCase().trim();
      const dir = document.getElementById('giftSort').value;

      let list = catalog.slice().sort((a, b) => {
        const av = a.diamond_count ?? (dir === 'asc' ? Infinity : -Infinity);
        const bv = b.diamond_count ?? (dir === 'asc' ? Infinity : -Infinity);
        return dir === 'asc' ? av - bv : bv - av;
      });

      if (q) {
        list = list.filter(g =>
          String(g.id).includes(q) ||
          (g.name||'').toLowerCase().includes(q)
        );
      }

      document.getElementById('giftList').innerHTML = list.map(giftRowTemplate).join('');

      // Attach event listeners
      list.forEach(g => {
        const mp3Input = document.getElementById(`mp3_${g.id}`);
        const volInput = document.getElementById(`vol_${g.id}`);
        if (mp3Input) mp3Input.oninput = (e) => updateAssignment(g.id, 'mp3_url', e.target.value.trim());
        if (volInput) volInput.oninput = (e) => updateAssignment(g.id, 'volume', Number(e.target.value));
      });
    }

    function giftRowTemplate(g) {
      const assigned = assignments[g.id] || {};
      const vol = assigned.volume ?? 1.0;
      const safeName = (g.name || '').replace(/"/g,'&quot;');
      const rowClass = `gift-row flex flex-col gap-2 border border-slate-800 rounded-xl p-3${assigned.mp3_url ? ' assigned' : ''}`;

      return `<div class="${rowClass}" data-gift-id="${g.id}">
        <div class="flex items-center gap-3">
          <input type="checkbox" class="gift-checkbox w-4 h-4 rounded cursor-pointer" data-gift-id="${g.id}" onchange="updateBulkSelection()" />
          <img src="${g.image_url || ''}" alt="" class="w-12 h-12 rounded-lg object-cover bg-black/30" onerror="this.style.display='none'"/>
          <div class="flex-1 min-w-0">
            <div class="font-medium text-sm">${safeName}</div>
            <div class="text-xs text-slate-400">ID: ${g.id} ¬∑ üíé ${g.diamond_count ?? '‚Äî'}</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <input id="mp3_${g.id}" value="${assigned.mp3_url || ''}" placeholder="MP3-URL"
                 class="flex-1 rounded-xl bg-slate-800 border border-slate-700 px-3 py-2 text-sm"
                 ondrop="handleDrop(event, ${g.id})" ondragover="handleDragOver(event)" />
          <input id="vol_${g.id}" type="range" min="0" max="1" step="0.05" value="${vol}"
                 class="w-24 flex-shrink-0" title="Lautst√§rke" />
          <button class="rounded-lg bg-amber-600 hover:bg-amber-500 px-3 py-1.5"
                  onclick="previewGift(${g.id})">‚ñ∂</button>
          <button class="rounded-lg bg-sky-600 hover:bg-sky-500 px-3 py-1.5"
                  onclick="openPicker('gift:${g.id}')">Picker</button>
          <button class="rounded-lg bg-rose-700/80 hover:bg-rose-600 px-3 py-1.5"
                  onclick="clearGift(${g.id})">‚úï</button>
        </div>
      </div>`;
    }

    function updateAssignment(id, key, value) {
      const g = catalog.find(x => x.id === id);
      if (!assignments[id]) assignments[id] = { label: g?.name || '' };
      assignments[id][key] = value;

      // Update visual state
      const row = document.querySelector(`.gift-row[data-gift-id='${id}']`);
      if (row) {
        row.classList.toggle('assigned', !!assignments[id].mp3_url);
      }

      // Save to history for undo/redo
      saveStateToHistory();
      hasUnsavedChanges = true;
    }

    function clearGift(id) {
      document.getElementById(`mp3_${id}`).value = '';
      document.getElementById(`vol_${id}`).value = 1;
      updateAssignment(id, 'mp3_url', '');
      updateAssignment(id, 'volume', 1.0);
    }

    function previewGift(id) {
      const url = document.getElementById(`mp3_${id}`).value.trim();
      const vol = document.getElementById(`vol_${id}`).value;
      if (url) playSound(url, vol, `Gift #${id} Preview`);
    }

    function previewSound(urlId, volId, label) {
      const url = document.getElementById(urlId).value.trim();
      const vol = document.getElementById(volId)?.value || 1.0;
      if (url) playSound(url, vol, label + ' Preview');
    }

    document.getElementById('giftSearch').oninput = renderGiftList;
    document.getElementById('giftSort').onchange = renderGiftList;

    // ========== Picker Dialog ==========
    function openPicker(targetId) {
      pickerTarget = targetId;
      document.getElementById('picker').classList.remove('hidden');
      document.getElementById('picker').classList.add('flex');
      document.getElementById('miUrl').value = '';
      switchTab('browse');

      // Auto-load trending sounds if not already loaded
      const trendingEl = document.getElementById('trendingResults');
      if (!trendingEl.children.length || trendingEl.textContent.includes('Keine')) {
        // Will be loaded when user switches to trending tab
      }
    }

    function closePicker() {
      document.getElementById('picker').classList.add('hidden');
      document.getElementById('picker').classList.remove('flex');
    }

    // Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
      // Escape: Close picker
      if (e.key === 'Escape') {
        const picker = document.getElementById('picker');
        if (!picker.classList.contains('hidden')) {
          closePicker();
        }
      }

      // Ctrl+S: Save
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        document.getElementById('btnSaveAll').click();
        showToast('üíæ Speichern mit Strg+S');
      }

      // Ctrl+E: Export
      if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        document.getElementById('btnExport').click();
      }

      // Ctrl+Z: Undo
      if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        undo();
      }

      // Ctrl+Y or Ctrl+Shift+Z: Redo
      if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'z')) {
        e.preventDefault();
        redo();
      }
    });

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.setAttribute('aria-selected','false'));
      document.querySelectorAll('[id^="tab-"]').forEach(p => p.classList.add('hidden'));

      const btn = document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`);
      if (btn) btn.setAttribute('aria-selected','true');

      const panel = document.getElementById('tab-' + tab);
      if (panel) {
        panel.classList.remove('hidden');
        panel.classList.add('flex');
      }

      // Auto-load content when switching to certain tabs
      if (tab === 'trending') {
        const trendingEl = document.getElementById('trendingResults');
        if (!trendingEl.children.length || trendingEl.innerHTML.includes('Keine')) {
          document.getElementById('btnLoadTrending').click();
        }
      }
      if (tab === 'random') {
        const randomEl = document.getElementById('randomResults');
        if (!randomEl.children.length || randomEl.innerHTML.includes('Keine')) {
          document.getElementById('btnLoadRandom').click();
        }
      }
    }

    document.getElementById('btnResolve').onclick = async () => {
      const url = document.getElementById('miUrl').value.trim();
      if (!url) return;

      showToast('L√∂se URL auf...');
      const result = await apiCall('/api/myinstants/resolve?url=' + encodeURIComponent(url));

      if (result.success && result.mp3) {
        document.getElementById('miUrl').value = result.mp3;
        showToast('MP3-URL extrahiert!');
      } else {
        showToast('Fehler: ' + (result.error || 'Unbekannt'));
      }
    };

    document.getElementById('btnUse').onclick = () => {
      assignToTarget(document.getElementById('miUrl').value.trim());
      closePicker();
    };

    // ========== Utility Functions ==========

    // API Caching
    async function cachedApiCall(url, bypassCache = false) {
      if (!bypassCache) {
        const cached = apiCache.get(url);
        if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
          console.log('üì¶ Cache hit:', url);
          return cached.data;
        }
      }

      const data = await apiCall(url);
      apiCache.set(url, { data, timestamp: Date.now() });
      return data;
    }

    // Sound Preview Validation
    async function validateMP3(url) {
      return new Promise((resolve) => {
        const audio = new Audio();
        const timeout = setTimeout(() => {
          audio.src = '';
          resolve(false);
        }, 5000); // 5s timeout

        audio.onloadedmetadata = () => {
          clearTimeout(timeout);
          audio.src = '';
          resolve(true);
        };

        audio.onerror = () => {
          clearTimeout(timeout);
          audio.src = '';
          resolve(false);
        };

        audio.src = url;
      });
    }

    // Duplicate Detection
    function detectDuplicates(url) {
      const duplicates = Object.entries(assignments).filter(([id, data]) =>
        data.mp3_url === url
      );

      if (duplicates.length > 0) {
        const giftNames = duplicates.map(([id]) => {
          const gift = catalog.find(g => g.id == id);
          return gift ? gift.name : `Gift ${id}`;
        }).join(', ');
        return `‚ö†Ô∏è Dieser Sound ist bereits zugeordnet zu: ${giftNames}`;
      }
      return null;
    }

    // Debounce Function
    function debounce(func, delay) {
      return function(...args) {
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => func.apply(this, args), delay);
      };
    }

    // Save State for Undo/Redo
    function saveStateToHistory() {
      // Remove future states if we're not at the end
      history.splice(historyIndex + 1);

      // Add current state
      history.push(JSON.parse(JSON.stringify(assignments)));
      historyIndex++;

      // Limit history size
      if (history.length > MAX_HISTORY) {
        history.shift();
        historyIndex--;
      }

      console.log(`üìú State saved (${historyIndex + 1}/${history.length})`);
    }

    // Undo
    function undo() {
      if (historyIndex > 0) {
        historyIndex--;
        assignments = JSON.parse(JSON.stringify(history[historyIndex]));
        renderGiftList();
        showToast(`‚Ü©Ô∏è R√ºckg√§ngig (${historyIndex + 1}/${history.length})`);
        hasUnsavedChanges = true;
      } else {
        showToast('‚ö†Ô∏è Nichts zum R√ºckg√§ngig machen');
      }
    }

    // Redo
    function redo() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        assignments = JSON.parse(JSON.stringify(history[historyIndex]));
        renderGiftList();
        showToast(`‚Ü™Ô∏è Wiederherstellen (${historyIndex + 1}/${history.length})`);
        hasUnsavedChanges = true;
      } else {
        showToast('‚ö†Ô∏è Nichts zum Wiederherstellen');
      }
    }

    // Favoriten Management
    function addToFavorites(sound) {
      if (!favorites.find(f => f.url === sound.url)) {
        favorites.push(sound);
        localStorage.setItem('soundFavorites', JSON.stringify(favorites));
        showToast(`‚≠ê Zu Favoriten hinzugef√ºgt: ${sound.name}`);
      } else {
        showToast('‚ÑπÔ∏è Bereits in Favoriten');
      }
    }

    function removeFromFavorites(url) {
      favorites = favorites.filter(f => f.url !== url);
      localStorage.setItem('soundFavorites', JSON.stringify(favorites));
      showToast('üóëÔ∏è Aus Favoriten entfernt');
    }

    // Auto-Save
    function startAutoSave() {
      if (autoSaveInterval) clearInterval(autoSaveInterval);

      autoSaveInterval = setInterval(() => {
        if (hasUnsavedChanges) {
          autoSave();
        }
      }, 30000); // Every 30 seconds

      console.log('üíæ Auto-Save aktiviert (alle 30s)');
    }

    async function autoSave() {
      try {
        // Save settings
        const settings = {
          soundboard_enabled: 'true',
          soundboard_play_mode: document.getElementById('play_mode').value,
          soundboard_max_queue_length: document.getElementById('queue_length').value,
          soundboard_follow_sound: document.getElementById('follow_sound').value.trim(),
          soundboard_follow_volume: document.getElementById('follow_volume').value,
          soundboard_subscribe_sound: document.getElementById('subscribe_sound').value.trim(),
          soundboard_subscribe_volume: document.getElementById('subscribe_volume').value,
          soundboard_share_sound: document.getElementById('share_sound').value.trim(),
          soundboard_share_volume: document.getElementById('share_volume').value,
          soundboard_like_sound: document.getElementById('like_sound').value.trim(),
          soundboard_like_volume: document.getElementById('like_volume').value,
          soundboard_like_threshold: document.getElementById('like_threshold').value,
          soundboard_like_window_seconds: document.getElementById('like_window_seconds').value,
          soundboard_default_gift_sound: document.getElementById('default_gift_sound').value.trim(),
          soundboard_gift_volume: document.getElementById('default_gift_volume').value
        };

        await apiCall('/api/settings', 'POST', settings);

        // Save gift assignments
        const gifts = Object.entries(assignments)
          .filter(([id, data]) => data.mp3_url)
          .map(([id, data]) => ({
            giftId: Number(id),
            label: data.label || `Gift ${id}`,
            mp3Url: data.mp3_url,
            volume: data.volume ?? 1.0
          }));

        for (const gift of gifts) {
          await apiCall('/api/soundboard/gifts', 'POST', gift);
        }

        hasUnsavedChanges = false;
        console.log(`üíæ Auto-Save erfolgreich (${gifts.length} Gifts)`);
      } catch (error) {
        console.error('‚ùå Auto-Save fehlgeschlagen:', error);
      }
    }

    // Unsaved Changes Warning
    window.addEventListener('beforeunload', (e) => {
      if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'Du hast ungespeicherte √Ñnderungen!';
      }
    });

    // ========== MyInstants API Functions ==========

    function showLoadingSkeleton(targetElement, count = 5) {
      targetElement.innerHTML = Array(count).fill(0).map(() => `
        <div class="animate-pulse border border-slate-700 rounded-xl p-3">
          <div class="h-4 bg-slate-700 rounded w-3/4 mb-2"></div>
          <div class="h-3 bg-slate-700 rounded w-1/2 mb-2"></div>
          <div class="h-3 bg-slate-700 rounded w-2/3"></div>
        </div>
      `).join('');
    }

    function renderSoundResults(items, targetElement, showPagination = false) {
      if (!items || items.length === 0) {
        targetElement.innerHTML = `
          <div class="flex flex-col items-center justify-center py-12 text-slate-400">
            <div class="text-4xl mb-2">üîç</div>
            <div class="text-sm">Keine Ergebnisse gefunden</div>
          </div>
        `;
        return;
      }

      const resultsHTML = items.map(item => {
        const mp3 = String(item.url || '').replace(/'/g, "&#39;");
        const title = String(item.name || 'Unbenannt').replace(/'/g, "&#39;");
        const description = String(item.description || '').replace(/'/g, "&#39;");
        const itemTags = (item.tags || []).slice(0, 4);
        const isFavorite = favorites.some(f => f.url === mp3);

        // Generate clickable tag pills
        const tagPills = itemTags.map(tag => {
          const safeTag = String(tag).replace(/'/g, "&#39;");
          return `<button class="inline-block px-2 py-0.5 rounded-full bg-slate-700 hover:bg-sky-600 text-xs transition-colors"
                          onclick="filterByCategory('${safeTag}')" title="Nach '${safeTag}' filtern">${safeTag}</button>`;
        }).join(' ');

        return `<div class="flex flex-col gap-2 border border-slate-700 rounded-xl p-3 hover:border-sky-500 transition-colors">
          <div class="flex items-start gap-2">
            <div class="flex-1 min-w-0">
              <div class="font-medium text-sm mb-1 truncate" title="${title}">${title}</div>
              ${description ? `<div class="text-xs text-slate-400 mb-1 line-clamp-2">${description}</div>` : ''}
              ${tagPills ? `<div class="text-xs flex gap-1 flex-wrap mt-1">${tagPills}</div>` : ''}
            </div>
            <div class="flex gap-1 flex-shrink-0">
              <button class="rounded-lg ${isFavorite ? 'bg-yellow-600 hover:bg-yellow-500' : 'bg-slate-600 hover:bg-slate-500'} px-2 py-1 text-sm"
                      onclick="${isFavorite ? `removeFromFavorites('${mp3}')` : `addToFavorites({name: '${title}', url: '${mp3}', description: '${description}', tags: ${JSON.stringify(itemTags)}})`}; renderFavorites();"
                      title="${isFavorite ? 'Aus Favoriten entfernen' : 'Zu Favoriten hinzuf√ºgen'}">‚≠ê</button>
              <button class="rounded-lg bg-amber-600 hover:bg-amber-500 px-2 py-1 text-sm"
                      onclick="playSound('${mp3}', 1.0, '${title}')" title="Vorschau">‚ñ∂</button>
              <button class="rounded-lg bg-sky-600 hover:bg-sky-500 px-2 py-1 text-sm"
                      onclick="assignToTarget('${mp3}'); closePicker();" title="Sound zuweisen">W√§hlen</button>
            </div>
          </div>
        </div>`;
      }).join('');

      targetElement.innerHTML = resultsHTML;

      // Add "Load More" button if pagination is enabled
      if (showPagination && items.length >= 20) {
        targetElement.innerHTML += `
          <div class="flex justify-center pt-4">
            <button id="btnLoadMore" class="rounded-xl bg-slate-700 hover:bg-slate-600 px-6 py-3 font-medium">
              Mehr laden
            </button>
          </div>
        `;
      }
    }

    // Render Favorites
    function renderFavorites() {
      const favoritesEl = document.getElementById('favoritesResults');
      if (!favoritesEl) return;

      if (favorites.length === 0) {
        favoritesEl.innerHTML = `
          <div class="flex flex-col items-center justify-center py-12 text-slate-400">
            <div class="text-4xl mb-2">‚≠ê</div>
            <div class="text-sm">Keine Favoriten gespeichert</div>
            <div class="text-xs mt-2">Klicke auf ‚≠ê um Sounds als Favoriten zu markieren</div>
          </div>
        `;
        return;
      }

      renderSoundResults(favorites, favoritesEl, false);
    }

    async function performSearch(query, page = 1) {
      if (!query) {
        document.getElementById('searchResults').innerHTML = '';
        return;
      }

      const resultsEl = document.getElementById('searchResults');

      // Only show skeleton on first page
      if (page === 1) {
        showLoadingSkeleton(resultsEl, 6);
      }

      try {
        const url = `/api/myinstants/search?query=${encodeURIComponent(query)}&page=${page}&limit=20`;
        const result = await cachedApiCall(url);

        if (result.success) {
          if (page === 1) {
            renderSoundResults(result.results, resultsEl, true);
            currentSearchQuery = query;
            currentSearchPage = 1;
          } else {
            // Append results for pagination
            const existingHTML = resultsEl.innerHTML;
            // Remove old "Load More" button
            resultsEl.innerHTML = existingHTML.replace(/<div class="flex justify-center.*?<\/div>\s*$/s, '');
            renderSoundResults(result.results, resultsEl, true);
          }

          // Setup "Load More" button
          const loadMoreBtn = document.getElementById('btnLoadMore');
          if (loadMoreBtn) {
            loadMoreBtn.onclick = () => {
              currentSearchPage++;
              performSearch(currentSearchQuery, currentSearchPage);
            };
          }

          if (result.results.length > 0 && page === 1) {
            showToast(`‚úÖ ${result.results.length} Sounds gefunden`);
          }
        } else {
          resultsEl.innerHTML = `
            <div class="flex flex-col items-center justify-center py-12 text-rose-400">
              <div class="text-4xl mb-2">‚ö†Ô∏è</div>
              <div class="text-sm">Fehler: ${result.error || 'Unbekannt'}</div>
            </div>
          `;
          if (page === 1) showToast('‚ùå Suche fehlgeschlagen');
        }
      } catch (error) {
        resultsEl.innerHTML = `
          <div class="flex flex-col items-center justify-center py-12 text-rose-400">
            <div class="text-4xl mb-2">üí•</div>
            <div class="text-sm">Netzwerkfehler: ${error.message}</div>
          </div>
        `;
        if (page === 1) showToast('‚ùå Verbindungsfehler');
      }
    }

    // Debounced live search
    const debouncedSearch = debounce((query) => {
      performSearch(query, 1);
    }, 500);

    document.getElementById('searchQuery').oninput = (e) => {
      const query = e.target.value.trim();
      if (query.length >= 2) {
        debouncedSearch(query);
      } else if (query.length === 0) {
        document.getElementById('searchResults').innerHTML = '';
      }
    };

    // Manual search button
    document.getElementById('btnSearch').onclick = () => {
      const query = document.getElementById('searchQuery').value.trim();
      if (!query) return showToast('‚ö†Ô∏è Bitte Suchbegriff eingeben');
      performSearch(query, 1);
    };

    // Enter key for manual search
    document.getElementById('searchQuery').onkeypress = (e) => {
      if (e.key === 'Enter') {
        const query = e.target.value.trim();
        if (query) performSearch(query, 1);
      }
    };

    // Clear cache button
    document.getElementById('btnClearCache').onclick = () => {
      apiCache.clear();
      showToast('üóëÔ∏è Cache geleert');
    };

    // Filter by category/tag
    function filterByCategory(category) {
      // Switch to search tab if not already there
      switchTab('search');

      // Set search query to the category
      document.getElementById('searchQuery').value = category;

      // Perform search
      performSearch(category, 1);

      showToast(`üè∑Ô∏è Suche nach: ${category}`);
    }

    // Clear favorites button
    document.getElementById('btnClearFavorites').onclick = () => {
      if (confirm('Alle Favoriten l√∂schen?')) {
        favorites = [];
        localStorage.setItem('soundFavorites', JSON.stringify(favorites));
        renderFavorites();
        showToast('üóëÔ∏è Alle Favoriten gel√∂scht');
      }
    };

    document.getElementById('btnLoadTrending').onclick = async () => {
      const resultsEl = document.getElementById('trendingResults');
      showLoadingSkeleton(resultsEl, 8);

      try {
        const result = await apiCall('/api/myinstants/trending?limit=30');

        if (result.success) {
          renderSoundResults(result.results, resultsEl);
          showToast(`üî• ${result.results.length} Trending Sounds geladen`);
        } else {
          resultsEl.innerHTML = `
            <div class="flex flex-col items-center justify-center py-12 text-rose-400">
              <div class="text-4xl mb-2">‚ö†Ô∏è</div>
              <div class="text-sm">Fehler: ${result.error || 'Unbekannt'}</div>
            </div>
          `;
          showToast('‚ùå Trending Sounds konnten nicht geladen werden');
        }
      } catch (error) {
        resultsEl.innerHTML = `
          <div class="flex flex-col items-center justify-center py-12 text-rose-400">
            <div class="text-4xl mb-2">üí•</div>
            <div class="text-sm">Verbindungsfehler</div>
          </div>
        `;
        showToast('‚ùå Verbindungsfehler');
    // ========== MyInstants API Functions ==========

    function renderSoundResults(items, targetElement) {
      if (!items || items.length === 0) {
        targetElement.innerHTML = `<div class="text-sm text-slate-400">Keine Ergebnisse gefunden</div>`;
        return;
      }

      targetElement.innerHTML = items.map(item => {
        const mp3 = String(item.url || '').replace(/'/g, "&#39;");
        const title = String(item.name || '').replace(/'/g, "&#39;");
        const description = String(item.description || '').replace(/'/g, "&#39;");
        const tags = (item.tags || []).slice(0, 3).join(', ');

        return `<div class="flex flex-col gap-2 border border-slate-700 rounded-xl p-3 hover:border-sky-500 transition-colors">
          <div class="flex items-start gap-2">
            <div class="flex-1">
              <div class="font-medium text-sm mb-1">${title}</div>
              ${description ? `<div class="text-xs text-slate-400 mb-1">${description}</div>` : ''}
              ${tags ? `<div class="text-xs text-slate-500">üè∑Ô∏è ${tags}</div>` : ''}
            </div>
            <div class="flex gap-1">
              <button class="rounded-lg bg-amber-600 hover:bg-amber-500 px-2 py-1 text-sm"
                      onclick="playSound('${mp3}', 1.0, '${title}')">‚ñ∂</button>
              <button class="rounded-lg bg-sky-600 hover:bg-sky-500 px-2 py-1 text-sm"
                      onclick="assignToTarget('${mp3}'); closePicker();">W√§hlen</button>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    document.getElementById('btnSearch').onclick = async () => {
      const query = document.getElementById('searchQuery').value.trim();
      if (!query) return showToast('Bitte Suchbegriff eingeben');

      const resultsEl = document.getElementById('searchResults');
      resultsEl.innerHTML = '<div class="text-sm text-slate-400">üîç Suche...</div>';

      const result = await apiCall('/api/myinstants/search?query=' + encodeURIComponent(query));

      if (result.success) {
        renderSoundResults(result.results, resultsEl);
        if (result.results.length > 0) {
          showToast(`${result.results.length} Sounds gefunden`);
        }
      } else {
        resultsEl.innerHTML = `<div class="text-sm text-rose-400">‚ùå Fehler: ${result.error || 'Unbekannt'}</div>`;
      }
    };

    // Enter key f√ºr Suche
    document.getElementById('searchQuery').onkeypress = (e) => {
      if (e.key === 'Enter') document.getElementById('btnSearch').click();
    };

    document.getElementById('btnLoadTrending').onclick = async () => {
      const resultsEl = document.getElementById('trendingResults');
      resultsEl.innerHTML = '<div class="text-sm text-slate-400">üî• Lade Trending Sounds...</div>';

      const result = await apiCall('/api/myinstants/trending?limit=30');

      if (result.success) {
        renderSoundResults(result.results, resultsEl);
      } else {
        resultsEl.innerHTML = `<div class="text-sm text-rose-400">‚ùå Fehler: ${result.error || 'Unbekannt'}</div>`;
      }
    };

    document.getElementById('btnLoadRandom').onclick = async () => {
      const resultsEl = document.getElementById('randomResults');
      resultsEl.innerHTML = '<div class="text-sm text-slate-400">üé≤ Lade zuf√§llige Sounds...</div>';

      const result = await apiCall('/api/myinstants/random?limit=30');

      if (result.success) {
        renderSoundResults(result.results, resultsEl);
      } else {
        resultsEl.innerHTML = `<div class="text-sm text-rose-400">‚ùå Fehler: ${result.error || 'Unbekannt'}</div>`;
      }
    };

    document.getElementById('btnLoadRandom').onclick = async () => {
      const resultsEl = document.getElementById('randomResults');
      showLoadingSkeleton(resultsEl, 8);

      try {
        const result = await apiCall('/api/myinstants/random?limit=30');

        if (result.success) {
          renderSoundResults(result.results, resultsEl);
          showToast(`üé≤ ${result.results.length} zuf√§llige Sounds geladen`);
        } else {
          resultsEl.innerHTML = `
            <div class="flex flex-col items-center justify-center py-12 text-rose-400">
              <div class="text-4xl mb-2">‚ö†Ô∏è</div>
              <div class="text-sm">Fehler: ${result.error || 'Unbekannt'}</div>
            </div>
          `;
          showToast('‚ùå Zuf√§llige Sounds konnten nicht geladen werden');
        }
      } catch (error) {
        resultsEl.innerHTML = `
          <div class="flex flex-col items-center justify-center py-12 text-rose-400">
            <div class="text-4xl mb-2">üí•</div>
            <div class="text-sm">Verbindungsfehler</div>
          </div>
        `;
        showToast('‚ùå Verbindungsfehler');
      }
    };

    async function assignToTarget(url) {
      if (!pickerTarget || !url) return;

      const cleanUrl = (url.match(/https?:\/\/[^\s"'<>]+?\.mp3[^\s"'<>]*/i) || [url])[0];

      // Validate MP3
      showToast('üîç Validiere Sound...');
      const isValid = await validateMP3(cleanUrl);

      if (!isValid) {
        if (!confirm('‚ö†Ô∏è Sound konnte nicht geladen werden. Trotzdem zuweisen?')) {
          return;
        }
      }

      // Handle bulk assignment
      if (pickerTarget === 'bulk:assign' && window.bulkAssignIds) {
        const ids = window.bulkAssignIds;
        ids.forEach(id => {
          document.getElementById(`mp3_${id}`).value = cleanUrl;
          updateAssignment(id, 'mp3_url', cleanUrl);
        });

        showToast(`‚úÖ Sound ${ids.length} Gifts zugewiesen!`);
        hasUnsavedChanges = true;

        // Clear selection
        document.querySelectorAll('.gift-checkbox').forEach(cb => cb.checked = false);
        updateBulkSelection();
        delete window.bulkAssignIds;
        return;
      }

      // Check for duplicates (only for single gift assignments)
      if (pickerTarget.startsWith('gift:')) {
        const duplicate = detectDuplicates(cleanUrl);
        if (duplicate) {
          if (!confirm(duplicate + '\n\nTrotzdem zuweisen?')) {
            return;
          }
        }
      }

      // Assign to single gift
      if (pickerTarget.startsWith('gift:')) {
        const id = Number(pickerTarget.split(':')[1]);
        document.getElementById(`mp3_${id}`).value = cleanUrl;
        updateAssignment(id, 'mp3_url', cleanUrl);
      } else {
        document.getElementById(pickerTarget).value = cleanUrl;
      }

      showToast('‚úÖ Sound zugewiesen!');
      hasUnsavedChanges = true;
    }

    // ========== Bulk Actions ==========
    function updateBulkSelection() {
      const checkboxes = document.querySelectorAll('.gift-checkbox');
      const selectedCheckboxes = Array.from(checkboxes).filter(cb => cb.checked);
      const count = selectedCheckboxes.length;

      // Update count and show/hide toolbar
      document.getElementById('bulkCount').textContent = `${count} ausgew√§hlt`;
      const toolbar = document.getElementById('bulkToolbar');
      if (count > 0) {
        toolbar.classList.remove('hidden');
      } else {
        toolbar.classList.add('hidden');
      }
    }

    function getSelectedGiftIds() {
      const checkboxes = document.querySelectorAll('.gift-checkbox:checked');
      return Array.from(checkboxes).map(cb => Number(cb.dataset.giftId));
    }

    document.getElementById('btnBulkSelectAll').onclick = () => {
      document.querySelectorAll('.gift-checkbox').forEach(cb => cb.checked = true);
      updateBulkSelection();
      showToast(`‚úÖ Alle ${document.querySelectorAll('.gift-checkbox').length} Gifts ausgew√§hlt`);
    };

    document.getElementById('btnBulkSelectNone').onclick = () => {
      document.querySelectorAll('.gift-checkbox').forEach(cb => cb.checked = false);
      updateBulkSelection();
      showToast('üî≤ Auswahl aufgehoben');
    };

    document.getElementById('btnBulkSelectAssigned').onclick = () => {
      document.querySelectorAll('.gift-checkbox').forEach(cb => {
        const giftId = Number(cb.dataset.giftId);
        cb.checked = !!assignments[giftId]?.mp3_url;
      });
      updateBulkSelection();
      const count = document.querySelectorAll('.gift-checkbox:checked').length;
      showToast(`‚úÖ ${count} zugeordnete Gifts ausgew√§hlt`);
    };

    document.getElementById('btnBulkAssign').onclick = () => {
      const selectedIds = getSelectedGiftIds();
      if (selectedIds.length === 0) {
        return showToast('‚ö†Ô∏è Keine Gifts ausgew√§hlt');
      }

      // Store selected IDs for bulk assignment
      window.bulkAssignIds = selectedIds;
      showToast(`üéµ W√§hle Sound f√ºr ${selectedIds.length} Gifts...`);

      // Open picker with special target
      pickerTarget = 'bulk:assign';
      document.getElementById('picker').classList.remove('hidden');
      document.getElementById('picker').classList.add('flex');
      switchTab('search');
    };

    document.getElementById('btnBulkClear').onclick = () => {
      const selectedIds = getSelectedGiftIds();
      if (selectedIds.length === 0) {
        return showToast('‚ö†Ô∏è Keine Gifts ausgew√§hlt');
      }

      if (!confirm(`Wirklich ${selectedIds.length} Sound-Zuweisungen l√∂schen?`)) {
        return;
      }

      selectedIds.forEach(id => {
        document.getElementById(`mp3_${id}`).value = '';
        document.getElementById(`vol_${id}`).value = 1;
        updateAssignment(id, 'mp3_url', '');
        updateAssignment(id, 'volume', 1.0);
      });

      // Deselect all
      document.querySelectorAll('.gift-checkbox').forEach(cb => cb.checked = false);
      updateBulkSelection();

      showToast(`üóëÔ∏è ${selectedIds.length} Zuweisungen gel√∂scht`);
    };

    // ========== Drag & Drop ==========
    function handleDragOver(event) {
      event.preventDefault();
      event.dataTransfer.dropEffect = 'copy';
    }

    function handleDrop(event, giftId) {
      event.preventDefault();

      let url = event.dataTransfer.getData('text/plain');

      // Extract MP3 URL if it's a full URL
      const mp3Match = url.match(/https?:\/\/[^\s"'<>]+?\.mp3[^\s"'<>]*/i);
      if (mp3Match) {
        url = mp3Match[0];
      }

      if (url && (url.includes('.mp3') || url.startsWith('http'))) {
        document.getElementById(`mp3_${giftId}`).value = url;
        updateAssignment(giftId, 'mp3_url', url);
        showToast(`‚úÖ Sound per Drag & Drop zugewiesen: Gift ${giftId}`);
        hasUnsavedChanges = true;
      } else {
        showToast('‚ö†Ô∏è Ung√ºltige URL. Nur MP3-URLs werden unterst√ºtzt.');
      }
    }

    // ========== Save Settings ==========
    document.getElementById('btnSaveAll').onclick = async () => {
      showToast('Speichere...');

      // Save event sounds settings
      const settings = {
        soundboard_enabled: 'true',
        soundboard_play_mode: document.getElementById('play_mode').value,
        soundboard_max_queue_length: document.getElementById('queue_length').value,
        soundboard_follow_sound: document.getElementById('follow_sound').value.trim(),
        soundboard_follow_volume: document.getElementById('follow_volume').value,
        soundboard_subscribe_sound: document.getElementById('subscribe_sound').value.trim(),
        soundboard_subscribe_volume: document.getElementById('subscribe_volume').value,
        soundboard_share_sound: document.getElementById('share_sound').value.trim(),
        soundboard_share_volume: document.getElementById('share_volume').value,
        soundboard_like_sound: document.getElementById('like_sound').value.trim(),
        soundboard_like_volume: document.getElementById('like_volume').value,
        soundboard_like_threshold: document.getElementById('like_threshold').value,
        soundboard_like_window_seconds: document.getElementById('like_window_seconds').value,
        soundboard_default_gift_sound: document.getElementById('default_gift_sound').value.trim(),
        soundboard_gift_volume: document.getElementById('default_gift_volume').value
      };

      await apiCall('/api/settings', 'POST', settings);

      // Save gift sound assignments
      const gifts = Object.entries(assignments)
        .filter(([id, data]) => data.mp3_url)
        .map(([id, data]) => ({
          giftId: Number(id),
          label: data.label || `Gift ${id}`,
          mp3Url: data.mp3_url,
          volume: data.volume ?? 1.0
        }));

      for (const gift of gifts) {
        await apiCall('/api/soundboard/gifts', 'POST', gift);
      }

      showToast(`‚úÖ Gespeichert! (${gifts.length} Gifts)`);
    };

    // ========== Export / Import / Reset ==========
    document.getElementById('btnExport').onclick = async () => {
      const settings = await apiCall('/api/settings');
      const gifts = await apiCall('/api/soundboard/gifts');

      const exportData = {
        settings,
        gifts,
        exportedAt: new Date().toISOString(),
        version: '1.0'
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `soundboard_config_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(link.href);

      showToast('‚úÖ Konfiguration exportiert!');
    };

    document.getElementById('importFile').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const data = JSON.parse(text);

        if (!data.settings && !data.gifts) {
          showToast('‚ùå Ung√ºltiges Format');
          return;
        }

        // Import settings
        if (data.settings) {
          await apiCall('/api/settings', 'POST', data.settings);

          // Update UI
          if (data.settings.soundboard_play_mode) {
            document.getElementById('play_mode').value = data.settings.soundboard_play_mode;
          }
          if (data.settings.soundboard_max_queue_length) {
            document.getElementById('queue_length').value = data.settings.soundboard_max_queue_length;
          }
          if (data.settings.soundboard_follow_sound) {
            document.getElementById('follow_sound').value = data.settings.soundboard_follow_sound;
          }
          if (data.settings.soundboard_follow_volume) {
            document.getElementById('follow_volume').value = data.settings.soundboard_follow_volume;
          }
          if (data.settings.soundboard_subscribe_sound) {
            document.getElementById('subscribe_sound').value = data.settings.soundboard_subscribe_sound;
          }
          if (data.settings.soundboard_subscribe_volume) {
            document.getElementById('subscribe_volume').value = data.settings.soundboard_subscribe_volume;
          }
          if (data.settings.soundboard_share_sound) {
            document.getElementById('share_sound').value = data.settings.soundboard_share_sound;
          }
          if (data.settings.soundboard_share_volume) {
            document.getElementById('share_volume').value = data.settings.soundboard_share_volume;
          }
          if (data.settings.soundboard_like_sound) {
            document.getElementById('like_sound').value = data.settings.soundboard_like_sound;
          }
          if (data.settings.soundboard_like_volume) {
            document.getElementById('like_volume').value = data.settings.soundboard_like_volume;
          }
          if (data.settings.soundboard_like_threshold) {
            document.getElementById('like_threshold').value = data.settings.soundboard_like_threshold;
          }
          if (data.settings.soundboard_like_window_seconds) {
            document.getElementById('like_window_seconds').value = data.settings.soundboard_like_window_seconds;
          }
          if (data.settings.soundboard_default_gift_sound) {
            document.getElementById('default_gift_sound').value = data.settings.soundboard_default_gift_sound;
          }
          if (data.settings.soundboard_gift_volume) {
            document.getElementById('default_gift_volume').value = data.settings.soundboard_gift_volume;
          }
        }

        // Import gift sounds
        if (data.gifts && Array.isArray(data.gifts)) {
          for (const gift of data.gifts) {
            await apiCall('/api/soundboard/gifts', 'POST', gift);

            // Update local assignments
            if (gift.giftId) {
              assignments[gift.giftId] = {
                mp3_url: gift.mp3Url || '',
                label: gift.label || '',
                volume: gift.volume ?? 1.0
              };
            }
          }

          // Refresh gift list
          renderGiftList();
        }

        showToast(`‚úÖ Import erfolgreich! (${data.gifts?.length || 0} Gifts)`);

        // Reset file input
        e.target.value = '';
      } catch (error) {
        console.error('Import error:', error);
        showToast('‚ùå Import fehlgeschlagen: ' + error.message);
      }
    };

    document.getElementById('btnReset').onclick = () => {
      if (confirm('Nicht gespeicherte √Ñnderungen verwerfen und neu laden?')) {
        location.reload();
      }
    };

    // ========== Theme Toggle ==========
    document.getElementById('themeToggle').onclick = () => {
      document.body.classList.toggle('light-mode');
      localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
    };

    if (localStorage.getItem('theme') === 'light') {
      document.body.classList.add('light-mode');
    }

    // ========== Load Settings on Start ==========
    async function loadSettings() {
      const settings = await apiCall('/api/settings');

      document.getElementById('play_mode').value = settings.soundboard_play_mode || 'overlap';
      document.getElementById('queue_length').value = settings.soundboard_max_queue_length || 10;
      document.getElementById('follow_sound').value = settings.soundboard_follow_sound || '';
      document.getElementById('follow_volume').value = settings.soundboard_follow_volume || 1.0;
      document.getElementById('subscribe_sound').value = settings.soundboard_subscribe_sound || '';
      document.getElementById('subscribe_volume').value = settings.soundboard_subscribe_volume || 1.0;
      document.getElementById('share_sound').value = settings.soundboard_share_sound || '';
      document.getElementById('share_volume').value = settings.soundboard_share_volume || 1.0;
      document.getElementById('like_sound').value = settings.soundboard_like_sound || '';
      document.getElementById('like_volume').value = settings.soundboard_like_volume || 1.0;
      document.getElementById('like_threshold').value = settings.soundboard_like_threshold || 0;
      document.getElementById('like_window_seconds').value = settings.soundboard_like_window_seconds || 10;
      document.getElementById('default_gift_sound').value = settings.soundboard_default_gift_sound || '';
      document.getElementById('default_gift_volume').value = settings.soundboard_gift_volume || 1.0;
    }

    // ========== Initialize ==========
    loadSettings();
    loadCatalog();
    startAutoSave(); // Enable auto-save every 30 seconds

    // Check connection status and load username
    apiCall('/api/status').then(data => {
      setStatus(data.isConnected);

      // Load current username into input field
      if (data.username) {
        document.getElementById('tiktok_user').value = data.username;
      }

      if (data.isConnected && data.username) {
        showToast(`Bereits verbunden mit @${data.username}`);
      }
    });
  </script>
</body>
</html>
